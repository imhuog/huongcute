<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cờ Lật Online - Enhanced Multiplayer Othello</title>
    <style>
        :root {
            /* Default Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: white;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --accent-color: #FFD700;
            --success-color: #00ff88;
            --error-color: #ff6b6b;
            --board-bg: #2d3748;
            --cell-bg: #4a5568;
            --cell-hover: #718096;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(0, 0, 0, 0.3);
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --board-bg: #1a1a1a;
            --cell-bg: #2c2c2c;
            --cell-hover: #3c3c3c;
        }

        /* Neon Theme */
        [data-theme="neon"] {
            --bg-primary: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
            --bg-secondary: rgba(16, 213, 194, 0.1);
            --text-primary: #00ff88;
            --text-secondary: #10d5c2;
            --accent-color: #ff0080;
            --success-color: #00ff88;
            --error-color: #ff0040;
            --board-bg: #000;
            --cell-bg: #1a1a2e;
            --cell-hover: #16213e;
        }

        /* Nature Theme */
        [data-theme="nature"] {
            --bg-primary: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --bg-secondary: rgba(255, 255, 255, 0.2);
            --text-primary: #2d5016;
            --text-secondary: #3e6b1f;
            --accent-color: #ff6b35;
            --success-color: #4caf50;
            --error-color: #f44336;
            --board-bg: #6b5b54;
            --cell-bg: #8b7355;
            --cell-hover: #a0845c;
        }

        /* Ocean Theme */
        [data-theme="ocean"] {
            --bg-primary: linear-gradient(135deg, #667db6 0%, #0082c8 100%);
            --bg-secondary: rgba(255, 255, 255, 0.15);
            --text-primary: white;
            --text-secondary: #e1f5fe;
            --accent-color: #ffd54f;
            --success-color: #26c6da;
            --error-color: #ef5350;
            --board-bg: #1565c0;
            --cell-bg: #1976d2;
            --cell-hover: #1e88e5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            color: var(--text-secondary);
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            border-left: 4px solid var(--accent-color);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 0, 0, 0.9));
        }

        .toast.error {
            border-left-color: var(--error-color);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(0, 0, 0, 0.9));
        }

        .toast.warning {
            border-left-color: #ffa726;
            background: linear-gradient(135deg, rgba(255, 167, 38, 0.15), rgba(0, 0, 0, 0.9));
        }

        .toast.info {
            border-left-color: #42a5f5;
            background: linear-gradient(135deg, rgba(66, 165, 245, 0.15), rgba(0, 0, 0, 0.9));
        }

        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Menu screens */
        .screen {
            display: none;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .screen.active {
            display: block;
        }

        .menu-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            color: white;
        }

        .btn-ai {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            min-width: 100px;
        }

        /* Room info */
        .room-info {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--success-color);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .room-id {
            font-size: 2rem;
            font-weight: bold;
            color: var(--success-color);
            margin-bottom: 10px;
        }

        .share-link {
            font-size: 0.9rem;
            word-break: break-all;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Piece selector styles */
        .piece-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .piece-option {
            font-size: 2rem;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid transparent;
            background: rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .piece-option:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .piece-option.selected {
            border-color: var(--accent-color);
            background: rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Game interface */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 100%;
        }

        .top-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
        }

        .top-section.local-mode {
            flex-direction: column;
            align-items: center;
        }

        .players-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            min-width: 200px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transform: scale(1.05);
        }

        .player-card.offline {
            opacity: 0.6;
            border-color: var(--error-color);
        }

        .player-card.ai {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        }

        .player-name {
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .emoji-selector {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .emoji-option {
            font-size: 1.5rem;
            padding: 5px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .emoji-option:hover {
            transform: scale(1.2);
            background: var(--bg-secondary);
        }

        .emoji-option.selected {
            border-color: var(--accent-color);
            background: rgba(255, 215, 0, 0.3);
        }

        .score {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Chat section */
        .chat-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 15px;
            width: 300px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-section.bottom {
            width: 100%;
            max-width: 600px;
            height: 200px;
            margin-top: 20px;
        }

        .chat-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 0.9rem;
        }

        .chat-sender {
            font-weight: bold;
            color: var(--accent-color);
        }

        .chat-input-container {
            display: flex;
            gap: 5px;
        }

        .chat-input {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 15px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .chat-send {
            padding: 8px 12px;
            border: none;
            border-radius: 50%;
            background: var(--success-color);
            color: white;
            cursor: pointer;
        }

        /* Stats and leaderboard */
        .stats-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 15px;
            width: 300px;
            height: 400px;
            overflow-y: auto;
        }

        .stats-header {
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .leaderboard-rank {
            font-weight: bold;
            color: var(--accent-color);
        }

        .leaderboard-name {
            flex: 1;
            margin: 0 10px;
        }

        .leaderboard-rating {
            font-weight: bold;
            color: var(--success-color);
        }

        /* Theme selector */
        .theme-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .theme-default { background: linear-gradient(135deg, #667eea, #764ba2); }
        .theme-dark { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .theme-neon { background: linear-gradient(135deg, #0f0f0f, #1a1a2e); }
        .theme-nature { background: linear-gradient(135deg, #56ab2f, #a8e6cf); }
        .theme-ocean { background: linear-gradient(135deg, #667db6, #0082c8); }

        .board-container {
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            background: var(--board-bg);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .cell {
            width: 40px;
            height: 40px;
            background: var(--cell-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .cell:hover {
            background: var(--cell-hover);
            transform: scale(1.05);
        }

        .cell.valid-move {
            border: 2px solid var(--success-color);
            animation: sparkle 1s infinite;
            background: rgba(0, 255, 136, 0.2);
        }

        .cell.valid-move:hover {
            background: rgba(0, 255, 136, 0.4);
        }

        @keyframes sparkle {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 136, 0.8); }
        }

        .piece {
            font-size: 1.8rem;
            animation: placepiece 0.3s ease-out;
            transition: transform 0.3s ease;
        }

        .piece.flipping {
            animation: flip 0.6s ease-in-out;
        }

        @keyframes placepiece {
            0% { transform: scale(0) rotate(180deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        .turn-indicator {
            text-align: center;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .connection-status.connected {
            background: var(--success-color);
            color: white;
        }

        .connection-status.disconnected {
            background: var(--error-color);
            color: white;
        }

        .connection-status.connecting {
            background: var(--accent-color);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .game-over-content {
            text-align: center;
            color: white;
            animation: bounceIn 0.8s ease-out;
        }

        .winner-announcement {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .final-score {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* AI thinking indicator */
        .ai-thinking {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--accent-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            .top-section {
                flex-direction: column;
            }
            .players-section {
                flex-direction: column;
                align-items: center;
            }
            .player-card, .chat-section, .stats-section {
                min-width: 280px;
                width: 100%;
                max-width: 350px;
            }
            .cell {
                width: 35px;
                height: 35px;
            }
            .piece {
                font-size: 1.5rem;
            }
            .btn {
                width: 200px;
                margin: 5px 0;
            }
            .toast {
                min-width: 250px;
                font-size: 0.9rem;
            }
            .toast-container {
                right: 10px;
                top: 10px;
            }
        }

        @media (max-width: 480px) {
            .cell {
                width: 30px;
                height: 30px;
            }
            .piece {
                font-size: 1.2rem;
            }
            .board {
                padding: 5px;
            }
        }
    </style>
</head>
<body data-theme="default">
    <div class="header">
        <h1 class="title">🌐 Cờ Lật Online Enhanced</h1>
        <p class="subtitle">AI • Chat • Leaderboard • Stats • Themes</p>
    </div>

    <div class="connection-status" id="connection-status">
        🔄 Đang kết nối...
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="screen active" id="main-menu">
        <div class="menu-card">
            <h2>📱 Chào mừng đến với Cờ Lật Online Enhanced!</h2>
            <p>Chơi cờ lật với bạn bè, AI, và nhiều tính năng mới</p>
            <div class="input-group">
                <label for="player-name">👤 Tên của bạn:</label>
                <input type="text" id="player-name" placeholder="Nhập tên của bạn..." maxlength="20">
            </div>
            <div class="theme-selector">
                <div class="theme-option theme-default selected" data-theme="default" title="Default"></div>
                <div class="theme-option theme-dark" data-theme="dark" title="Dark"></div>
                <div class="theme-option theme-neon" data-theme="neon" title="Neon"></div>
                <div class="theme-option theme-nature" data-theme="nature" title="Nature"></div>
                <div class="theme-option theme-ocean" data-theme="ocean" title="Ocean"></div>
            </div>
            <div style="margin: 30px 0;">
                <button class="btn btn-primary" onclick="createRoom('online')">
                    🏠 Tạo Phòng Online
                </button>
                <button class="btn btn-secondary" onclick="showJoinRoom()">
                    🚪 Vào Phòng
                </button>
            </div>
            <div style="margin: 20px 0;">
                <button class="btn btn-ai" onclick="showAIMenu()">
                    🤖 Chơi với AI
                </button>
                <button class="btn btn-info" onclick="playOffline()">
                    🎮 Chơi Local
                </button>
            </div>
            <div style="margin: 20px 0;">
                <button class="btn btn-secondary btn-small" onclick="showLeaderboard()">
                    🏆 Bảng Xếp Hạng
                </button>
                <button class="btn btn-info btn-small" onclick="showStats()">
                    📊 Thống Kê
                </button>
            </div>
        </div>
    </div>

    <!-- New screen for joining room via link -->
    <div class="screen" id="join-via-link-screen">
        <div class="menu-card">
            <h2>🚪 Tham Gia Phòng <span id="join-link-room-id"></span></h2>
            <p>Bạn được mời tham gia phòng này</p>
            
            <div class="input-group">
                <label for="join-link-player-name">👤 Tên của bạn:</label>
                <input type="text" id="join-link-player-name" placeholder="Nhập tên của bạn..." maxlength="20">
            </div>

            <div class="input-group">
                <label>🎯 Chọn hình dáng quân cờ của bạn:</label>
                <div class="piece-selector" id="join-link-piece-selector">
                    <div class="piece-option selected" data-piece="⚫">⚫</div>
                    <div class="piece-option" data-piece="🔴">🔴</div>
                    <div class="piece-option" data-piece="🟤">🟤</div>
                    <div class="piece-option" data-piece="🟫">🟫</div>
                    <div class="piece-option" data-piece="⭕">⭕</div>
                    <div class="piece-option" data-piece="🔵">🔵</div>
                    <div class="piece-option" data-piece="🟣">🟣</div>
                    <div class="piece-option" data-piece="🟢">🟢</div>
                </div>
            </div>

            <div class="theme-selector">
                <div class="theme-option theme-default selected" data-theme="default" title="Default"></div>
                <div class="theme-option theme-dark" data-theme="dark" title="Dark"></div>
                <div class="theme-option theme-neon" data-theme="neon" title="Neon"></div>
                <div class="theme-option theme-nature" data-theme="nature" title="Nature"></div>
                <div class="theme-option theme-ocean" data-theme="ocean" title="Ocean"></div>
            </div>

            <button class="btn btn-primary" onclick="joinRoomViaLink()">
                🚀 Tham Gia Phòng
            </button>
            <button class="btn btn-secondary" onclick="backToMenu()">
                ⬅️ Quay Lại Menu
            </button>
        </div>
    </div>

    <div class="screen" id="ai-menu-screen">
        <div class="menu-card">
            <h2>🤖 Chọn Độ Khó AI</h2>
            <div class="input-group">
                <label for="ai-difficulty">🎯 Độ khó:</label>
                <select id="ai-difficulty">
                    <option value="easy">😊 Dễ - AI Mèo</option>
                    <option value="medium" selected>🤔 Trung Bình - AI Thông Minh</option>
                    <option value="hard">😈 Khó - AI Siêu Cấp</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <button class="btn btn-ai" onclick="createAIRoom()">
                    🚀 Bắt Đầu với AI
                </button>
                <button class="btn btn-secondary" onclick="backToMenu()">
                    ⬅️ Quay Lại
                </button>
            </div>
        </div>
    </div>

    <div class="screen" id="join-room-screen">
        <div class="menu-card">
            <h2>🚪 Tham Gia Phòng</h2>
            <div class="input-group">
                <label for="room-id-input">🆔 ID Phòng:</label>
                <input type="text" id="room-id-input" placeholder="Nhập ID phòng...">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">
                🚀 Tham Gia
            </button>
            <button class="btn btn-secondary" onclick="backToMenu()">
                ⬅️ Quay Lại
            </button>
        </div>
    </div>

    <div class="screen" id="room-lobby-screen">
        <div class="menu-card">
            <h2>🏠 Phòng Game <span id="lobby-room-id"></span></h2>
            <div class="room-info">
                <p>ID Phòng: <span class="room-id" id="display-room-id"></span></p>
                <p>Link Chia Sẻ: <span class="share-link" id="share-link"></span></p>
                <button class="btn btn-info btn-small" onclick="copyShareLink()">Sao chép Link</button>
                <p style="margin-top: 15px;">Người chơi hiện tại: <span id="players-in-lobby">0/2</span></p>
                <div id="lobby-player-names" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
            <button class="btn btn-primary" id="start-game-button" onclick="startGame()" disabled>
                ▶️ Bắt Đầu Game
            </button>
            <button class="btn btn-secondary" onclick="leaveRoom()">
                ↩️ Rời Phòng
            </button>
        </div>
    </div>

    <div class="screen" id="game-screen">
        <div class="game-container">
            <div class="top-section" id="top-section">
                <div class="players-section">
                    <div class="player-card" id="player-black-card">
                        <span class="player-name" id="player-black-name"></span>
                        <div class="emoji-selector" id="emoji-selector-black"></div>
                        <span class="score" id="score-black">2</span>
                    </div>
                    <div class="player-card" id="player-white-card">
                        <span class="player-name" id="player-white-name"></span>
                        <div class="emoji-selector" id="emoji-selector-white"></div>
                        <span class="score" id="score-white">2</span>
                    </div>
                </div>

                <div class="chat-section" id="chat-section">
                    <div class="tabs">
                        <button class="tab active" data-tab="chat-tab">💬 Chat</button>
                        <button class="tab" data-tab="leaderboard-tab" onclick="game.loadLeaderboardData()">🏆 BXH</button>
                        <button class="tab" data-tab="stats-tab" onclick="game.loadStatsData(game.playerName)">📊 Stats</button>
                    </div>

                    <div class="tab-content active" id="chat-tab-content">
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input-container">
                            <input type="text" id="chat-input" class="chat-input" placeholder="Nhắn tin...">
                            <button class="chat-send" onclick="sendChatMessage()">▶️</button>
                        </div>
                    </div>

                    <div class="tab-content" id="leaderboard-tab-content">
                        <h3 class="stats-header">🏆 Bảng Xếp Hạng</h3>
                        <ul id="leaderboard-list" style="list-style: none; padding: 0;">
                            <p>Đang tải bảng xếp hạng...</p>
                        </ul>
                    </div>

                    <div class="tab-content" id="stats-tab-content">
                        <h3 class="stats-header">📊 Thống Kê Người Chơi: <span id="stats-player-name"></span></h3>
                        <div id="stats-list">
                            <p>Chọn tên người chơi để xem thống kê.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="turn-indicator" id="turn-indicator">Đang chờ người chơi...</div>
            <div class="board-container">
                <div class="board" id="game-board"></div>
                <div class="ai-thinking" id="ai-thinking-indicator" style="display: none;">
                    AI đang suy nghĩ...
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-secondary btn-small" onclick="resetGame()">🔄 Chơi Lại</button>
                <button class="btn btn-info btn-small" onclick="showRules()">❓ Luật Chơi</button>
                <button class="btn btn-primary btn-small" onclick="leaveGame()">↩️ Thoát Game</button>
            </div>
        </div>
    </div>

    <div class="modal" id="rules-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-primary); padding: 30px; border-radius: 20px; text-align: center; max-width: 500px; margin: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); color: var(--text-primary);">
            <h2 style="color: var(--accent-color); margin-bottom: 20px; font-size: 2rem;">❓ Luật Chơi Cờ Lật (Othello/Reversi)</h2>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Mục tiêu của trò chơi là có nhiều quân cờ của bạn hơn đối thủ khi bàn cờ đầy hoặc không còn nước đi hợp lệ.
            </p>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Bạn và đối thủ sẽ thay phiên đặt quân cờ của mình (đen hoặc trắng) lên bàn cờ 8x8.
            </p>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Khi đặt một quân cờ, bạn phải kẹp ít nhất một quân cờ của đối thủ giữa quân cờ mới đặt và một quân cờ khác của bạn đã có sẵn trên bàn cờ, theo chiều ngang, dọc hoặc chéo.
            </p>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Tất cả các quân cờ bị kẹp của đối thủ sẽ bị lật sang màu của bạn.
            </p>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Nếu bạn không có nước đi hợp lệ, lượt sẽ tự động chuyển sang đối thủ. Trò chơi kết thúc khi không bên nào có nước đi hợp lệ hoặc khi bàn cờ đầy.
            </p>
            <button class="btn btn-primary" onclick="closeModal()">Đóng</button>
        </div>
    </div>

    <div class="game-over" id="game-over-screen">
        <div class="game-over-content">
            <h1 class="winner-announcement" id="winner-announcement"></h1>
            <p class="final-score" id="final-score"></p>
            <button class="btn btn-primary" onclick="resetGame()">Chơi Lại</button>
            <button class="btn btn-secondary" onclick="leaveGame()">Thoát Game</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
        const SERVER_URL = "https://huongcute.onrender.com"; // Địa chỉ server của bạn

        class EnhancedOthelloGame {
            constructor() {
                this.socket = null;
                this.playerName = localStorage.getItem('playerName') || '';
                this.roomId = null;
                this.isOnlineMode = false;
                this.playerColor = null; // 'black' or 'white'
                this.board = [];
                this.turn = 'black';
                this.validMoves = [];
                this.gameActive = false;
                this.emojis = ['😊', '😂', '😍', '😡', '😭', '👍', '👎', '🎉'];
                this.selectedEmoji = '';
                this.aiDifficulty = 'medium';
                this.playerBlackEmoji = '⚫';
                this.playerWhiteEmoji = '⚪';
                this.selectedPieceEmoji = '⚫'; // For join via link screen
                this.pendingRoomId = null; // Store room ID when joining via link

                // Initialize connection on game start
                this.initializeConnection();
                this.setupEventListeners();
                this.renderMainMenu();
                this.loadPlayerName();
                this.loadTheme();
                this.updateConnectionStatus(false); // Initial status
                
                // Check for room link in URL
                this.checkForRoomLink();
            }

            checkForRoomLink() {
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('room');
                if (roomId) {
                    this.pendingRoomId = roomId;
                    this.showJoinViaLinkScreen(roomId);
                }
            }

            showJoinViaLinkScreen(roomId) {
                document.getElementById('join-link-room-id').textContent = roomId;
                
                // Load saved player name if available
                const savedPlayerName = localStorage.getItem('playerName');
                if (savedPlayerName) {
                    document.getElementById('join-link-player-name').value = savedPlayerName;
                }
                
                this.showScreen('join-via-link-screen');
                this.showToast(`Sẵn sàng tham gia phòng ${roomId}!`, 'info');
            }

            setupPieceSelectorListeners() {
                // Setup piece selector for join via link screen
                document.querySelectorAll('#join-link-piece-selector .piece-option').forEach(option => {
                    option.addEventListener('click', () => {
                        // Remove selected class from all options
                        document.querySelectorAll('#join-link-piece-selector .piece-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Add selected class to clicked option
                        option.classList.add('selected');
                        this.selectedPieceEmoji = option.dataset.piece;
                    });
                });
            }

            joinRoomViaLink() {
                const playerName = document.getElementById('join-link-player-name').value.trim();
                
                if (!playerName) {
                    this.showToast('Vui lòng nhập tên của bạn.', 'error');
                    return;
                }
                
                if (!this.pendingRoomId) {
                    this.showToast('Không tìm thấy ID phòng.', 'error');
                    return;
                }

                // Save player preferences
                this.playerName = playerName;
                localStorage.setItem('playerName', playerName);
                
                // Set selected piece emoji for the player
                this.playerBlackEmoji = this.selectedPieceEmoji; // Assuming they'll be black player
                
                // Join the room
                this.isOnlineMode = true;
                this.socket.emit('joinRoom', { 
                    roomId: this.pendingRoomId, 
                    playerName: playerName 
                });
                
                this.showToast('Đang vào phòng...', 'info');
            }

            showToast(message, type = 'info', duration = 4000) {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span>${message}</span>
                    <button class="toast-close" onclick="this.parentElement.remove()">×</button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Show toast with animation
                setTimeout(() => toast.classList.add('show'), 10);
                
                // Auto remove after duration
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }

            initializeConnection() {
                if (this.socket) {
                    this.socket.disconnect(); // Disconnect existing socket if any
                }
                this.socket = io(SERVER_URL); // Connect to your Render server

                this.socket.on('connect', () => {
                    console.log('Successfully connected to Socket.IO server!');
                    this.updateConnectionStatus(true);
                    if (this.playerName) {
                        this.socket.emit('playerConnected', this.playerName);
                    }
                });

                this.socket.on('disconnect', (reason) => {
                    console.log('Disconnected from Socket.IO server:', reason);
                    this.updateConnectionStatus(false);
                    if (reason === 'io server disconnect') {
                        this.showToast('Mất kết nối với máy chủ. Vui lòng thử lại sau.', 'error');
                    } else {
                        this.showToast('Mất kết nối. Đang thử kết nối lại...', 'warning');
                    }
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket.IO connection error:', error);
                    this.updateConnectionStatus(false);
                    this.showToast('Lỗi kết nối đến máy chủ. Đang thử lại...', 'error');
                });

                // Fixed server event handlers
                this.socket.on('roomCreated', (data) => {
                    if (data && data.success) {
                        this.roomId = data.roomId;
                        this.isOnlineMode = true;
                        this.showScreen('room-lobby-screen');
                        document.getElementById('display-room-id').textContent = this.roomId;
                        document.getElementById('lobby-room-id').textContent = `(${this.roomId})`;
                        const shareLink = `${window.location.origin}?room=${this.roomId}`;
                        document.getElementById('share-link').textContent = shareLink;
                        this.showToast(`Phòng ${this.roomId} đã được tạo!`, 'success');
                    }
                });

                this.socket.on('roomJoined', (data) => {
                    if (data && data.success && data.gameState) {
                        this.roomId = data.gameState.roomId;
                        this.isOnlineMode = true;
                        this.playerColor = data.playerColor;
                        
                        // Clear URL parameters after successful join
                        if (window.history && window.history.replaceState) {
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                        
                        this.showScreen('room-lobby-screen');
                        document.getElementById('display-room-id').textContent = this.roomId;
                        document.getElementById('lobby-room-id').textContent = `(${this.roomId})`;
                        const shareLink = `${window.location.origin}?room=${this.roomId}`;
                        document.getElementById('share-link').textContent = shareLink;
                        this.updateLobbyUI(data.gameState);
                        this.showToast(`Đã vào phòng ${this.roomId}!`, 'success');
                    }
                });

                this.socket.on('roomError', (data) => {
                    this.showToast(data.message || 'Có lỗi xảy ra với phòng.', 'error');
                    this.backToMenu();
                });

                this.socket.on('playerJoined', (data) => {
                    if (data && data.gameState) {
                        this.updateLobbyUI(data.gameState);
                        this.showToast('Người chơi mới đã tham gia phòng!', 'info');
                    }
                });

                this.socket.on('gameStarted', (data) => {
                    if (data && data.success && data.gameState) {
                        this.startOnlineGame(data.gameState);
                    }
                });

                this.socket.on('boardUpdate', (data) => {
                    if (data && data.success && data.gameState) {
                        this.updateGameState(data.gameState);
                    }
                });

                this.socket.on('turnUpdate', (data) => {
                    if (data) {
                        this.turn = data.currentPlayer === 1 ? 'black' : 'white';
                        this.validMoves = data.validMoves || [];
                        this.updateTurnIndicator();
                        this.updateValidMoves();
                    }
                });

                this.socket.on('gameEnded', (data) => {
                    if (data && data.success && data.gameState) {
                        this.handleGameEnd(data.gameState);
                    }
                });

                this.socket.on('newChatMessage', (data) => {
                    if (data && data.message) {
                        this.addChatMessage(data.message.sender, data.message.message);
                    }
                });

                this.socket.on('moveError', (data) => {
                    this.showToast(data.message || 'Nước đi không hợp lệ!', 'warning');
                });
            }

            setupEventListeners() {
                document.getElementById('game-board').addEventListener('click', (event) => {
                    if (this.gameActive && this.isOnlineMode && this.isMyTurn()) {
                        const cell = event.target.closest('.cell');
                        if (cell) {
                            const row = parseInt(cell.dataset.row);
                            const col = parseInt(cell.dataset.col);
                            this.makeMove(row, col);
                        }
                    } else if (this.gameActive && !this.isOnlineMode && this.turn === 'black') { // Local play
                        const cell = event.target.closest('.cell');
                        if (cell) {
                            const row = parseInt(cell.dataset.row);
                            const col = parseInt(cell.dataset.col);
                            this.makeLocalMove(row, col);
                        }
                    }
                });

                document.getElementById('player-name').addEventListener('input', (event) => {
                    this.playerName = event.target.value;
                    localStorage.setItem('playerName', this.playerName);
                });

                document.getElementById('chat-input').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        this.sendChatMessage();
                    }
                });

                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.dataset.theme;
                        this.setTheme(theme);
                    });
                });

                // Add tab switching functionality
                document.addEventListener('click', (event) => {
                    if (event.target.classList.contains('tab')) {
                        const tabName = event.target.dataset.tab;
                        this.switchTab(tabName);
                    }
                });

                // Setup piece selector listeners
                this.setupPieceSelectorListeners();
            }

            isMyTurn() {
                if (!this.isOnlineMode) return this.turn === 'black';
                
                const currentPlayerColor = this.turn === 'black' ? 1 : 2;
                return this.playerColor === currentPlayerColor;
            }

            startOnlineGame(gameState) {
                this.gameActive = true;
                this.showScreen('game-screen');
                this.updateGameState(gameState);
                this.showToast('Game đã bắt đầu!', 'success');
            }

            updateGameState(gameState) {
                this.board = gameState.board;
                this.turn = gameState.currentPlayer === 1 ? 'black' : 'white';
                this.validMoves = gameState.validMoves || [];
                
                // Update player names
                const blackPlayer = gameState.players.find(p => p.color === 1);
                const whitePlayer = gameState.players.find(p => p.color === 2);
                
                if (blackPlayer) this.playerBlackName = blackPlayer.name;
                if (whitePlayer) this.playerWhiteName = whitePlayer.name;
                
                // Update scores
                const scores = gameState.scores || { 1: 2, 2: 2 };
                document.getElementById('score-black').textContent = scores[1];
                document.getElementById('score-white').textContent = scores[2];
                
                this.updateBoard();
                this.updateTurnIndicator();
                this.updatePlayerCards();
            }

            handleGameEnd(gameState) {
                this.gameActive = false;
                const winnerAnnouncement = document.getElementById('winner-announcement');
                const finalScore = document.getElementById('final-score');
                
                if (gameState.winner === 1) {
                    winnerAnnouncement.textContent = `${this.playerBlackName} thắng! 🎉`;
                } else if (gameState.winner === 2) {
                    winnerAnnouncement.textContent = `${this.playerWhiteName} thắng! 🎉`;
                } else {
                    winnerAnnouncement.textContent = 'Hòa! 🤝';
                }
                
                const scores = gameState.scores || { 1: 0, 2: 0 };
                finalScore.textContent = `Tỷ số: Đen ${scores[1]} - Trắng ${scores[2]}`;
                this.showGameOverScreen();
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                
                // Adjust layout for local/AI games
                if (screenId === 'game-screen') {
                    const topSection = document.getElementById('top-section');
                    const chatSection = document.getElementById('chat-section');
                    
                    if (!this.isOnlineMode) {
                        // For local/AI games, move chat to bottom
                        topSection.classList.add('local-mode');
                        chatSection.classList.add('bottom');
                        // Move chat section after the board
                        const gameContainer = document.querySelector('.game-container');
                        const boardContainer = document.querySelector('.board-container');
                        gameContainer.insertBefore(chatSection, boardContainer.nextSibling);
                    } else {
                        // For online games, keep chat in sidebar
                        topSection.classList.remove('local-mode');
                        chatSection.classList.remove('bottom');
                        // Move chat section back to top section
                        topSection.appendChild(chatSection);
                    }
                }
            }

            renderMainMenu() {
                this.showScreen('main-menu');
            }

            loadPlayerName() {
                const playerNameInput = document.getElementById('player-name');
                if (this.playerName) {
                    playerNameInput.value = this.playerName;
                }
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('theme') || 'default';
                this.setTheme(savedTheme);
            }

            setTheme(theme) {
                document.body.dataset.theme = theme;
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.theme === theme) {
                        option.classList.add('selected');
                    }
                });
                localStorage.setItem('theme', theme);
            }

            updateConnectionStatus(isConnected) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    statusElement.classList.remove('connected', 'disconnected', 'connecting');
                    if (isConnected) {
                        statusElement.textContent = '✅ Đã kết nối';
                        statusElement.classList.add('connected');
                    } else {
                        statusElement.textContent = '❌ Mất kết nối';
                        statusElement.classList.add('disconnected');
                    }
                }
            }

            showGameOverScreen() {
                document.getElementById('game-over-screen').style.display = 'flex';
            }

            hideGameOverScreen() {
                document.getElementById('game-over-screen').style.display = 'none';
            }

            showJoinRoom() {
                this.showScreen('join-room-screen');
            }

            showAIMenu() {
                this.showScreen('ai-menu-screen');
            }

            // Game Logic
            createRoom(mode) {
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên của bạn.', 'error');
                    return;
                }
                localStorage.setItem('playerName', this.playerName);
                if (mode === 'online') {
                    this.isOnlineMode = true;
                    this.socket.emit('createRoom', { 
                        playerName: this.playerName,
                        roomName: null
                    });
                    this.showToast('Đang tạo phòng...', 'info');
                }
            }

            joinRoom() {
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên của bạn.', 'error');
                    return;
                }
                const roomId = document.getElementById('room-id-input').value.trim();
                if (!roomId) {
                    this.showToast('Vui lòng nhập ID phòng.', 'error');
                    return;
                }
                localStorage.setItem('playerName', this.playerName);
                this.isOnlineMode = true;
                this.socket.emit('joinRoom', { 
                    roomId: roomId, 
                    playerName: this.playerName 
                });
                this.showToast('Đang vào phòng...', 'info');
            }

            updateLobbyUI(gameState) {
                const playersInLobby = document.getElementById('players-in-lobby');
                const lobbyPlayerNames = document.getElementById('lobby-player-names');
                const connectedPlayers = gameState.players.filter(p => p.connected);
                
                playersInLobby.textContent = `${connectedPlayers.length}/2`;
                lobbyPlayerNames.innerHTML = connectedPlayers.map(p => 
                    `<span>${p.name} (${p.color === 1 ? 'Đen' : 'Trắng'}) ${p.connected ? '✅' : '❌'}</span>`
                ).join('<br>');

                const startGameButton = document.getElementById('start-game-button');
                if (connectedPlayers.length === 2) {
                    startGameButton.disabled = false;
                } else {
                    startGameButton.disabled = true;
                }
            }

            startGame() {
                if (this.isOnlineMode && this.socket) {
                    this.socket.emit('startGame', { roomId: this.roomId });
                }
            }

            leaveRoom() {
                if (this.isOnlineMode && this.socket && this.roomId) {
                    this.socket.emit('leaveRoom');
                }
                this.roomId = null;
                this.isOnlineMode = false;
                this.playerColor = null;
                this.resetGameData();
                this.backToMenu();
            }

            leaveGame() {
                if (this.isOnlineMode && this.socket && this.roomId) {
                    this.socket.emit('leaveRoom');
                }
                this.roomId = null;
                this.isOnlineMode = false;
                this.playerColor = null;
                this.resetGameData();
                this.backToMenu();
                this.hideGameOverScreen();
            }

            resetGameData() {
                this.board = [];
                this.turn = 'black';
                this.validMoves = [];
                this.gameActive = false;
                this.playerBlackName = 'Người chơi Đen';
                this.playerWhiteName = 'Người chơi Trắng';
                this.playerBlackEmoji = '⚫';
                this.playerWhiteEmoji = '⚪';
                document.getElementById('score-black').textContent = '2';
                document.getElementById('score-white').textContent = '2';
                document.getElementById('chat-messages').innerHTML = '';
                document.getElementById('player-black-card').classList.remove('active', 'offline', 'ai');
                document.getElementById('player-white-card').classList.remove('active', 'offline', 'ai');
                document.getElementById('ai-thinking-indicator').style.display = 'none';
            }

            resetGame() {
                if (this.isOnlineMode && this.socket && this.roomId) {
                    this.socket.emit('restartGame', { roomId: this.roomId });
                    this.showToast('Yêu cầu chơi lại đã được gửi!', 'info');
                } else if (!this.isOnlineMode) {
                    this.startLocalGame();
                }
                this.hideGameOverScreen();
            }

            startLocalGame() {
                this.isOnlineMode = false;
                this.playerColor = 'black';
                this.playerBlackName = this.playerName || 'Người chơi Đen';
                this.playerWhiteName = 'Người chơi Trắng';
                this.gameActive = true;
                this.initBoard();
                this.updateBoard();
                this.updateTurnIndicator();
                this.updatePlayerCards();
                this.showScreen('game-screen');
                this.showToast('Đã bắt đầu chơi cục bộ!', 'info');
            }

            createAIRoom() {
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên của bạn.', 'error');
                    return;
                }
                this.aiDifficulty = document.getElementById('ai-difficulty').value;
                this.isOnlineMode = false;
                this.playerColor = 'black';
                this.playerBlackName = this.playerName;
                this.playerWhiteName = `AI ${this.aiDifficulty === 'easy' ? 'Mèo' : this.aiDifficulty === 'medium' ? 'Thông Minh' : 'Siêu Cấp'}`;
                this.gameActive = true;
                this.initBoard();
                this.updateBoard();
                this.updateTurnIndicator();
                this.updatePlayerCards();
                document.getElementById('player-white-card').classList.add('ai');
                this.showScreen('game-screen');
                this.showToast('Bắt đầu chơi với AI!', 'info');
            }

            playOffline() {
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên của bạn.', 'error');
                    return;
                }
                this.startLocalGame();
            }

            // Board and Game State Management
            initBoard() {
                this.board = Array(8).fill(null).map(() => Array(8).fill(null));
                this.board[3][3] = 'white';
                this.board[3][4] = 'black';
                this.board[4][3] = 'black';
                this.board[4][4] = 'white';
                this.turn = 'black';
                this.validMoves = this.getValidMoves(this.board, this.turn);
            }

            updateBoard() {
                const gameBoard = document.getElementById('game-board');
                gameBoard.innerHTML = '';
                
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        
                        if (this.validMoves && this.validMoves.some(move => 
                            (move.r === r && move.c === c) || (move.row === r && move.col === c))) {
                            cell.classList.add('valid-move');
                        }
                        
                        const piece = document.createElement('span');
                        piece.className = 'piece';
                        
                        if (this.board[r][c] === 'black' || this.board[r][c] === 1) {
                            piece.textContent = this.playerBlackEmoji;
                        } else if (this.board[r][c] === 'white' || this.board[r][c] === 2) {
                            piece.textContent = this.playerWhiteEmoji;
                        }
                        
                        cell.appendChild(piece);
                        gameBoard.appendChild(cell);
                    }
                }
                
                // Update scores for local games
                if (!this.isOnlineMode) {
                    const scores = this.getScores(this.board);
                    document.getElementById('score-black').textContent = scores.black;
                    document.getElementById('score-white').textContent = scores.white;
                }
            }

            updateValidMoves() {
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => cell.classList.remove('valid-move'));
                
                if (this.validMoves) {
                    this.validMoves.forEach(move => {
                        const r = move.r !== undefined ? move.r : move.row;
                        const c = move.c !== undefined ? move.c : move.col;
                        const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                        if (cell) {
                            cell.classList.add('valid-move');
                        }
                    });
                }
            }

            updateTurnIndicator() {
                const indicator = document.getElementById('turn-indicator');
                const currentPlayerName = this.turn === 'black' ? this.playerBlackName : this.playerWhiteName;
                const currentEmoji = this.turn === 'black' ? this.playerBlackEmoji : this.playerWhiteEmoji;
                
                if (this.isOnlineMode) {
                    if (this.isMyTurn()) {
                        indicator.textContent = `Lượt của bạn! (${currentEmoji})`;
                    } else {
                        indicator.textContent = `Lượt của: ${currentPlayerName} (${currentEmoji})`;
                    }
                } else {
                    indicator.textContent = `Lượt của: ${currentPlayerName} (${currentEmoji})`;
                }

                const blackCard = document.getElementById('player-black-card');
                const whiteCard = document.getElementById('player-white-card');
                
                blackCard.classList.remove('active');
                whiteCard.classList.remove('active');

                if (this.turn === 'black') {
                    blackCard.classList.add('active');
                } else {
                    whiteCard.classList.add('active');
                }

                // AI turn logic for local AI game
                if (!this.isOnlineMode && this.turn === 'white' && this.playerWhiteName.includes('AI')) {
                    this.showAIThinkingIndicator(true);
                    setTimeout(() => {
                        this.makeAIMove();
                        this.showAIThinkingIndicator(false);
                    }, 1000);
                }
            }

            updatePlayerCards() {
                document.getElementById('player-black-name').textContent = this.playerBlackName;
                document.getElementById('player-white-name').textContent = this.playerWhiteName;
                this.renderEmojiSelectors();
            }

            renderEmojiSelectors() {
                const emojiSelectorBlack = document.getElementById('emoji-selector-black');
                const emojiSelectorWhite = document.getElementById('emoji-selector-white');
                emojiSelectorBlack.innerHTML = '';
                emojiSelectorWhite.innerHTML = '';

                const pieceOptions = ['⚫', '🔴', '🟤', '🟫', '⭕', '🔵', '🟣', '🟢'];

                if (this.isOnlineMode) {
                    if (this.playerColor === 1) { // Black player
                        pieceOptions.forEach(emoji => {
                            const span = document.createElement('span');
                            span.className = `emoji-option ${this.playerBlackEmoji === emoji ? 'selected' : ''}`;
                            span.textContent = emoji;
                            span.onclick = () => this.selectEmoji(emoji);
                            emojiSelectorBlack.appendChild(span);
                        });
                        if (this.playerWhiteEmoji) {
                            const opponentEmojiSpan = document.createElement('span');
                            opponentEmojiSpan.className = 'emoji-option selected';
                            opponentEmojiSpan.textContent = this.playerWhiteEmoji;
                            emojiSelectorWhite.appendChild(opponentEmojiSpan);
                        }
                    } else if (this.playerColor === 2) { // White player
                        pieceOptions.forEach(emoji => {
                            const span = document.createElement('span');
                            span.className = `emoji-option ${this.playerWhiteEmoji === emoji ? 'selected' : ''}`;
                            span.textContent = emoji;
                            span.onclick = () => this.selectEmoji(emoji);
                            emojiSelectorWhite.appendChild(span);
                        });
                        if (this.playerBlackEmoji) {
                            const opponentEmojiSpan = document.createElement('span');
                            opponentEmojiSpan.className = 'emoji-option selected';
                            opponentEmojiSpan.textContent = this.playerBlackEmoji;
                            emojiSelectorBlack.appendChild(opponentEmojiSpan);
                        }
                    }
                } else { // Local & AI mode
                    pieceOptions.forEach(emoji => {
                        const span = document.createElement('span');
                        span.className = `emoji-option ${this.playerBlackEmoji === emoji ? 'selected' : ''}`;
                        span.textContent = emoji;
                        span.onclick = () => this.selectEmoji(emoji);
                        emojiSelectorBlack.appendChild(span);
                    });
                    if (this.playerWhiteEmoji) {
                        const whiteEmojiSpan = document.createElement('span');
                        whiteEmojiSpan.className = 'emoji-option selected';
                        whiteEmojiSpan.textContent = this.playerWhiteEmoji;
                        emojiSelectorWhite.appendChild(whiteEmojiSpan);
                    }
                }
            }

            selectEmoji(emoji) {
                this.selectedEmoji = emoji;
                if (this.isOnlineMode && this.socket) {
                    // Send emoji selection to server - will need server-side implementation
                    // this.socket.emit('playerEmoji', { roomId: this.roomId, emoji: emoji });
                } else {
                    if (this.playerColor === 'black' || !this.isOnlineMode) {
                        this.playerBlackEmoji = emoji;
                        this.renderEmojiSelectors();
                        this.updateBoard();
                    }
                }
            }

            getScores(board) {
                let black = 0;
                let white = 0;
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (board[r][c] === 'black' || board[r][c] === 1) black++;
                        else if (board[r][c] === 'white' || board[r][c] === 2) white++;
                    }
                }
                return { black, white };
            }

            isValidMove(board, row, col, player) {
                if (board[row][col] !== null && board[row][col] !== 0) return false;

                const opponent = player === 'black' ? 'white' : 'black';
                let hasFlips = false;

                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],           [0, 1],
                    [1, -1], [1, 0], [1, 1]
                ];

                for (const [dr, dc] of directions) {
                    let r = row + dr;
                    let c = col + dc;
                    let path = [];

                    while (r >= 0 && r < 8 && c >= 0 && c < 8 && board[r][c] === opponent) {
                        path.push({ r, c });
                        r += dr;
                        c += dc;
                    }

                    if (r >= 0 && r < 8 && c >= 0 && c < 8 && board[r][c] === player && path.length > 0) {
                        hasFlips = true;
                        break;
                    }
                }
                return hasFlips;
            }

            getValidMoves(board, player) {
                const moves = [];
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.isValidMove(board, r, c, player)) {
                            moves.push({ row: r, col: c, r: r, c: c });
                        }
                    }
                }
                return moves;
            }

            makeMove(row, col) {
                if (this.isOnlineMode && this.socket && this.gameActive && this.isMyTurn()) {
                    if (this.validMoves.some(move => 
                        (move.row === row && move.col === col) || (move.r === row && move.c === col))) {
                        this.socket.emit('makeMove', { roomId: this.roomId, r: row, c: col });
                    } else {
                        this.showToast('Nước đi không hợp lệ!', 'warning');
                    }
                }
            }

            // Local Game Logic
            makeLocalMove(row, col) {
                if (this.gameActive && this.turn === 'black') {
                    const moves = this.getValidMoves(this.board, 'black');
                    if (moves.some(move => move.row === row && move.col === col)) {
                        let newBoard = this.flipPieces(this.board, row, col, 'black');
                        this.board = newBoard;
                        this.turn = 'white';
                        this.updateBoard();
                        this.updateTurnIndicator();

                        const aiMoves = this.getValidMoves(this.board, 'white');
                        if (aiMoves.length === 0) {
                            const playerMovesAfterAI = this.getValidMoves(this.board, 'black');
                            if (playerMovesAfterAI.length === 0) {
                                this.endGameLocal();
                            } else {
                                this.turn = 'black';
                                this.validMoves = playerMovesAfterAI;
                                this.updateTurnIndicator();
                                this.updateValidMoves();
                                this.showToast('AI không có nước đi, lượt của bạn!', 'info');
                            }
                        }
                    } else {
                        this.showToast('Nước đi không hợp lệ!', 'warning');
                    }
                }
            }

            flipPieces(board, row, col, player) {
                const newBoard = JSON.parse(JSON.stringify(board));
                const opponent = player === 'black' ? 'white' : 'black';
                newBoard[row][col] = player;

                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],           [0, 1],
                    [1, -1], [1, 0], [1, 1]
                ];

                for (const [dr, dc] of directions) {
                    let r = row + dr;
                    let c = col + dc;
                    let path = [];

                    while (r >= 0 && r < 8 && c >= 0 && c < 8 && newBoard[r][c] === opponent) {
                        path.push({ r, c });
                        r += dr;
                        c += dc;
                    }

                    if (r >= 0 && r < 8 && c >= 0 && c < 8 && newBoard[r][c] === player && path.length > 0) {
                        path.forEach(p => {
                            newBoard[p.r][p.c] = player;
                        });
                    }
                }
                return newBoard;
            }

            makeAIMove() {
                const aiMoves = this.getValidMoves(this.board, 'white');
                if (aiMoves.length > 0) {
                    let bestMove = null;
                    if (this.aiDifficulty === 'easy') {
                        bestMove = aiMoves[Math.floor(Math.random() * aiMoves.length)];
                    } else if (this.aiDifficulty === 'medium') {
                        bestMove = this.getMediumAIMove(this.board, aiMoves);
                    } else if (this.aiDifficulty === 'hard') {
                        bestMove = this.getHardAIMove(this.board, aiMoves);
                    }

                    if (bestMove) {
                        let newBoard = this.flipPieces(this.board, bestMove.row, bestMove.col, 'white');
                        this.board = newBoard;
                        this.turn = 'black';
                        this.validMoves = this.getValidMoves(this.board, 'black');
                        this.updateBoard();
                        this.updateTurnIndicator();

                        if (this.validMoves.length === 0) {
                            const aiMovesAfterPlayer = this.getValidMoves(this.board, 'white');
                            if (aiMovesAfterPlayer.length === 0) {
                                this.endGameLocal();
                            } else {
                                this.turn = 'white';
                                this.updateTurnIndicator();
                                this.showToast('Bạn không có nước đi, lượt của AI!', 'info');
                                this.showAIThinkingIndicator(true);
                                setTimeout(() => {
                                    this.makeAIMove();
                                    this.showAIThinkingIndicator(false);
                                }, 1000);
                            }
                        }
                    }
                } else {
                    this.endGameLocal();
                }
            }

            getMediumAIMove(board, validMoves) {
                let bestMove = null;
                let maxFlips = -1;

                for (const move of validMoves) {
                    const r = move.row;
                    const c = move.col;

                    if ((r === 0 && c === 0) || (r === 0 && c === 7) || (r === 7 && c === 0) || (r === 7 && c === 7)) {
                        return move;
                    }

                    const tempBoard = this.flipPieces(JSON.parse(JSON.stringify(board)), r, c, 'white');
                    const flips = this.getScores(tempBoard).white - this.getScores(board).white;
                    if (flips > maxFlips) {
                        maxFlips = flips;
                        bestMove = move;
                    }
                }
                return bestMove || validMoves[0];
            }

            getHardAIMove(board, validMoves) {
                let bestMove = null;
                let maxScore = -Infinity;

                const scoreTable = [
                    [100, -20, 10, 5, 5, 10, -20, 100],
                    [-20, -50, -2, -2, -2, -2, -50, -20],
                    [10, -2, 5, 1, 1, 5, -2, 10],
                    [5, -2, 1, 1, 1, 1, -2, 5],
                    [5, -2, 1, 1, 1, 1, -2, 5],
                    [10, -2, 5, 1, 1, 5, -2, 10],
                    [-20, -50, -2, -2, -2, -2, -50, -20],
                    [100, -20, 10, 5, 5, 10, -20, 100]
                ];

                for (const move of validMoves) {
                    const r = move.row;
                    const c = move.col;
                    let currentScore = scoreTable[r][c];

                    const tempBoard = this.flipPieces(JSON.parse(JSON.stringify(board)), r, c, 'white');
                    const flips = this.getScores(tempBoard).white - this.getScores(board).white;
                    currentScore += flips;

                    if (currentScore > maxScore) {
                        maxScore = currentScore;
                        bestMove = move;
                    }
                }
                return bestMove || validMoves[0];
            }

            endGameLocal() {
                this.gameActive = false;
                const scores = this.getScores(this.board);
                const winnerAnnouncement = document.getElementById('winner-announcement');
                const finalScore = document.getElementById('final-score');

                if (scores.black > scores.white) {
                    winnerAnnouncement.textContent = `${this.playerBlackName} thắng! 🎉`;
                } else if (scores.white > scores.black) {
                    winnerAnnouncement.textContent = `${this.playerWhiteName} thắng! 🎉`;
                } else {
                    winnerAnnouncement.textContent = 'Hòa! 🤝';
                }
                finalScore.textContent = `Tỷ số: Đen ${scores.black} - Trắng ${scores.white}`;
                this.showGameOverScreen();
            }

            showAIThinkingIndicator(show) {
                document.getElementById('ai-thinking-indicator').style.display = show ? 'block' : 'none';
            }

            // Other UI related functions
            backToMenu() {
                this.showScreen('main-menu');
                document.getElementById('room-id-input').value = '';
                this.resetGameData();
                this.pendingRoomId = null;
                
                // Clear URL parameters
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            copyShareLink() {
                const shareLink = document.getElementById('share-link').textContent;
                navigator.clipboard.writeText(shareLink).then(() => {
                    this.showToast('Đã sao chép link chia sẻ!', 'success');
                }).catch(err => {
                    console.error('Không thể sao chép link: ', err);
                    this.showToast('Không thể sao chép link.', 'error');
                });
            }

            showRules() {
                document.getElementById('rules-modal').style.display = 'flex';
            }

            closeModal() {
                document.getElementById('rules-modal').style.display = 'none';
            }

            sendChatMessage() {
                const chatInput = document.getElementById('chat-input');
                const message = chatInput.value.trim();
                if (message && this.isOnlineMode && this.socket && this.roomId) {
                    this.socket.emit('chatMessage', { roomId: this.roomId, message: message });
                    chatInput.value = '';
                } else if (message && !this.isOnlineMode) {
                    this.addChatMessage(this.playerName, message);
                    chatInput.value = '';
                }
            }

            addChatMessage(sender, message, emoji) {
                const chatMessages = document.getElementById('chat-messages');
                const msgElement = document.createElement('div');
                msgElement.className = 'chat-message';
                msgElement.innerHTML = `<span class="chat-sender">${sender} ${emoji || ''}:</span> ${message}`;
                chatMessages.appendChild(msgElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async loadLeaderboardData() {
                try {
                    const response = await fetch(`${SERVER_URL}/api/leaderboard`);
                    const data = await response.json();
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    
                    if (data.success && data.leaderboard && data.leaderboard.length > 0) {
                        data.leaderboard.forEach((player, index) => {
                            const li = document.createElement('li');
                            li.className = 'leaderboard-item';
                            li.innerHTML = `
                                <span class="leaderboard-rank">#${index + 1}</span>
                                <span class="leaderboard-name">${player.name}</span>
                                <span class="leaderboard-rating">${player.rating} điểm</span>
                            `;
                            leaderboardList.appendChild(li);
                        });
                    } else {
                        leaderboardList.innerHTML = '<p>Chưa có ai trên bảng xếp hạng.</p>';
                    }
                } catch (error) {
                    console.error('Lỗi khi tải bảng xếp hạng:', error);
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '<p>Không thể tải bảng xếp hạng.</p>';
                    this.showToast('Không thể tải bảng xếp hạng.', 'error');
                }
            }

            async loadStatsData(playerName) {
                const statsList = document.getElementById('stats-list');
                const statsPlayerName = document.getElementById('stats-player-name');
                statsPlayerName.textContent = playerName;
                statsList.innerHTML = '<p>Đang tải thống kê...</p>';
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/stats/${encodeURIComponent(playerName)}`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            statsList.innerHTML = '<p>Không tìm thấy thống kê cho người chơi này.</p>';
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return;
                    }
                    const data = await response.json();
                    if (data.success && data.player) {
                        const stats = data.player.stats;
                        const rating = data.player.rating;
                        statsList.innerHTML = `
                            <div class="stat-item"><span>Rating:</span><span>${rating.rating} điểm</span></div>
                            <div class="stat-item"><span>Tổng số trận:</span><span>${stats.totalGames}</span></div>
                            <div class="stat-item"><span>Thắng:</span><span>${stats.wins}</span></div>
                            <div class="stat-item"><span>Thua:</span><span>${stats.losses}</span></div>
                            <div class="stat-item"><span>Hòa:</span><span>${stats.ties}</span></div>
                            <div class="stat-item"><span>Điểm ghi được:</span><span>${stats.pointsScored}</span></div>
                            <div class="stat-item"><span>Điểm bị trừ:</span><span>${stats.pointsConceded}</span></div>
                            <div class="stat-item"><span>Tỷ lệ thắng:</span><span>${((stats.wins / stats.totalGames) * 100 || 0).toFixed(2)}%</span></div>
                        `;
                    } else {
                        statsList.innerHTML = '<p>Không thể tải thống kê người chơi.</p>';
                    }
                } catch (error) {
                    console.error('Lỗi khi tải thống kê:', error);
                    statsList.innerHTML = '<p>Không thể tải thống kê người chơi.</p>';
                    this.showToast('Không thể tải thống kê người chơi.', 'error');
                }
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                document.getElementById(`${tabName}-content`).classList.add('active');
                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            }

            showLeaderboard() {
                this.showToast('Tính năng bảng xếp hạng chỉ có trong chế độ online', 'info');
            }

            showStats() {
                this.showToast('Tính năng thống kê chỉ có trong chế độ online', 'info');
            }
        }

        let game;

        function createRoom(mode) {
            game.createRoom(mode);
        }

        function showJoinRoom() {
            game.showJoinRoom();
        }

        function joinRoom() {
            game.joinRoom();
        }

        function joinRoomViaLink() {
            game.joinRoomViaLink();
        }

        function startGame() {
            game.startGame();
        }

        function showAIMenu() {
            game.showAIMenu();
        }

        function createAIRoom() {
            game.createAIRoom();
        }

        function playOffline() {
            game.playOffline();
        }

        function backToMenu() {
            game.backToMenu();
        }

        function copyShareLink() {
            game.copyShareLink();
        }

        function leaveRoom() {
            game.leaveRoom();
        }

        function leaveGame() {
            game.leaveGame();
        }

        function resetGame() {
            game.resetGame();
        }

        function showRules() {
            game.showRules();
        }

        function closeModal() {
            game.closeModal();
        }

        function sendChatMessage() {
            game.sendChatMessage();
        }

        function showLeaderboard() {
            game.showLeaderboard();
        }

        function showStats() {
            game.showStats();
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', () => {
            game = new EnhancedOthelloGame();
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (game && game.isOnlineMode && game.socket) {
                if (document.hidden) {
                    // Page hidden
                } else {
                    // Page visible - reconnect if needed
                    if (game.socket.disconnected) {
                        game.socket.connect();
                    }
                }
            }
        });
    </script>
</body>
</html>
