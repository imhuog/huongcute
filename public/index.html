<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cờ Lật Online - Enhanced Multiplayer Othello</title>
    <style>
        :root {
            /* Default Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: white;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --accent-color: #FFD700;
            --success-color: #00ff88;
            --error-color: #ff6b6b;
            --board-bg: #2d3748;
            --cell-bg: #4a5568;
            --cell-hover: #718096;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(0, 0, 0, 0.3);
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --accent-color: #f1c40f;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --board-bg: #1a202c;
            --cell-bg: #2d3748;
            --cell-hover: #4a5568;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            --bg-secondary: rgba(0, 0, 0, 0.05);
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --board-bg: #cbd5e0;
            --cell-bg: #e2e8f0;
            --cell-hover: #edf2f7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            overflow-y: auto;
            flex-direction: column; /* Allow content to stack vertically */
        }

        .container {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            width: 800px;
            box-sizing: border-box;
            margin: 20px 0; /* Add vertical margin */
        }

        h1, h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        button, input[type="text"], input[type="number"] {
            padding: 12px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        button {
            background-color: var(--accent-color);
            color: var(--text-primary);
            cursor: pointer;
            min-width: 120px;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        input[type="text"], input[type="number"] {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            width: calc(100% - 40px);
        }

        input[type="text"]::placeholder, input[type="number"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 3px var(--accent-color);
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Game Board Specific Styles */
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: clamp(250px, 80vw, 500px); /* Responsive board size */
            height: clamp(250px, 80vw, 500px);
            background-color: var(--board-bg);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .cell {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--cell-bg);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .cell:hover:not(.piece):not(.invalid-move) {
            background-color: var(--cell-hover);
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .piece.black { background-color: black; }
        .piece.white { background-color: white; }

        .valid-move-indicator {
            width: 30%;
            height: 30%;
            border-radius: 50%;
            background-color: var(--accent-color);
            opacity: 0.7;
            pointer-events: none; /* Allows clicks to pass through to the cell */
        }
        
        /* Game Info & Scores */
        .game-info, .player-info, .room-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            margin-top: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .player-score, .room-id-display, .player-status {
            background-color: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 10px;
            margin: 5px;
            min-width: 100px;
            box-sizing: border-box;
        }

        .current-turn-indicator {
            font-weight: bold;
            color: var(--accent-color);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.9; }
        }

        .game-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Notifications (simplified for alert) */
        .notification {
            display: none; /* This will be handled by alert now */
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 1000;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chat Section */
        .chat-section {
            background-color: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .chat-message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .chat-message strong {
            color: var(--accent-color);
        }

        .chat-input {
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            margin-right: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            border: none;
            width: auto; /* Override general input width */
        }

        .chat-input button {
            padding: 10px 15px;
            margin: 0;
            min-width: auto;
        }

        /* Room List */
        .room-list-container {
            margin-top: 20px;
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .room-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .room-item:last-child {
            border-bottom: none;
        }

        .room-item span {
            flex-grow: 1;
            text-align: left;
        }

        .room-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }

        .tab-button.active {
            background-color: var(--accent-color);
        }

        .tab-content .screen {
            display: none;
        }

        .tab-content .screen.active {
            display: block;
        }

        /* Theming Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .theme-toggle img {
            width: 24px;
            height: 24px;
            filter: invert(var(--text-primary-invert-filter, 0)); /* For icon color */
        }
        
        /* Modal for Rules/Game Over */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-primary);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%; /* Could be responsive */
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            color: var(--text-primary);
        }

        .close-button {
            color: var(--text-secondary);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--accent-color);
            text-decoration: none;
            cursor: pointer;
        }

        .rules-content ul {
            list-style-type: disc;
            padding-left: 20px;
            text-align: left;
        }

        .rules-content li {
            margin-bottom: 10px;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            button, input[type="text"], input[type="number"] {
                padding: 10px 15px;
                font-size: 14px;
            }

            .game-info, .player-info, .room-info {
                flex-direction: column;
            }

            .player-score, .room-id-display, .player-status {
                width: calc(100% - 10px); /* Full width minus margin */
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="theme-toggle" id="theme-toggle">
        <img id="theme-icon" src="image_79de3b.png" alt="Theme Icon">
        <span id="theme-name">Chủ đề tối</span>
    </div>

    <div class="container">
        <div id="main-menu" class="screen active">
            <h1>Cờ Lật Online</h1>
            <button id="play-offline-btn">Chơi Offline</button>
            <button id="show-online-options-btn">Chơi Online</button>
            <button id="show-leaderboard-btn">Bảng Xếp Hạng</button>
            <button id="show-rules-btn">Luật Chơi</button>
        </div>

        <div id="online-options-screen" class="screen">
            <h2>Chơi Online</h2>
            <input type="text" id="player-name-input" placeholder="Nhập tên của bạn">
            <input type="text" id="room-name-input" placeholder="Nhập tên phòng (tùy chọn)">
            <button id="create-room-btn">Tạo Phòng Online</button>
            <button id="show-join-room-btn">Tham Gia Phòng</button>
            <button id="back-to-main-from-online">Quay Lại</button>
        </div>

        <div id="join-room-screen" class="screen">
            <h2>Tham Gia Phòng</h2>
            <input type="text" id="join-player-name-input" placeholder="Nhập tên của bạn">
            <input type="text" id="room-id-input" placeholder="Nhập ID phòng">
            <button id="join-room-btn">Tham Gia</button>
            <button id="back-to-online-options">Quay Lại</button>
        </div>

        <div id="room-info-screen" class="screen">
            <h2>Phòng của bạn: <span id="display-room-name"></span> (<span id="current-room-id"></span>)</h2>
            <div class="room-info">
                <p>Host: <span id="host-name-display"></span></p>
                <p>Bạn: <span id="your-player-name"></span></p>
                <p>Đối thủ: <span id="opponent-name-display">Đang chờ...</span></p>
            </div>
            <button id="copy-room-link-btn">Sao chép Link Phòng</button>
            <button id="start-game-btn" style="display: none;">Bắt Đầu Game</button>
            <div class="chat-section">
                <h3>Trò chuyện</h3>
                <div class="chat-messages" id="room-chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="room-chat-input" placeholder="Gửi tin nhắn...">
                    <button id="send-room-chat-btn">Gửi</button>
                </div>
            </div>
            <button id="leave-room-btn">Rời Phòng</button>
        </div>

        <div id="room-list-screen" class="screen">
            <h2>Danh sách Phòng Online</h2>
            <div class="room-list-container">
                <ul id="rooms-list" class="room-list">
                    </ul>
            </div>
            <button id="refresh-room-list-btn">Làm Mới Danh Sách</button>
            <button id="back-to-online-options-from-list">Quay Lại</button>
        </div>

        <div id="game-screen" class="screen">
            <div class="game-info">
                <div class="player-score">Đen: <span id="black-score">2</span></div>
                <div class="player-score">Trắng: <span id="white-score">2</span></div>
                <div class="player-status">Lượt hiện tại: <span id="current-turn"></span></div>
            </div>
            <div class="game-board" id="game-board">
                </div>
            <div class="game-buttons">
                <button id="restart-game-btn" style="display: none;">Chơi Lại</button>
                <button id="leave-game-btn">Kết Thúc Game</button>
            </div>
            <div class="chat-section">
                <h3>Trò chuyện</h3>
                <div class="chat-messages" id="game-chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="game-chat-input" placeholder="Gửi tin nhắn...">
                    <button id="send-game-chat-btn">Gửi</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-screen" class="screen">
            <h2>Bảng Xếp Hạng</h2>
            <div class="tab-nav">
                <button class="tab-button active" data-tab="ratings">Xếp hạng</button>
                <button class="tab-button" data-tab="stats">Thống kê</button>
            </div>
            <div class="tab-content">
                <div id="ratings-tab" class="screen active">
                    <table id="leaderboard-table" border="1" style="width:100%; border-collapse: collapse; color: var(--text-secondary);">
                        <thead>
                            <tr style="background-color: var(--cell-hover);">
                                <th style="padding: 8px;">Hạng</th>
                                <th style="padding: 8px;">Tên</th>
                                <th style="padding: 8px;">Điểm</th>
                                <th style="padding: 8px;">Thắng</th>
                                <th style="padding: 8px;">Thua</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div id="stats-tab" class="screen">
                    <table id="stats-table" border="1" style="width:100%; border-collapse: collapse; color: var(--text-secondary);">
                        <thead>
                            <tr style="background-color: var(--cell-hover);">
                                <th style="padding: 8px;">Tên</th>
                                <th style="padding: 8px;">Tổng trận</th>
                                <th style="padding: 8px;">Thắng</th>
                                <th style="padding: 8px;">Thua</th>
                                <th style="padding: 8px;">Hòa</th>
                                <th style="padding: 8px;">Điểm ghi</th>
                                <th style="padding: 8px;">Điểm thua</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            <button id="back-to-main-from-leaderboard">Quay Lại</button>
        </div>
    </div>

    <div id="game-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
            <button id="modal-action-btn" style="display: none;">Chơi lại</button>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-message">Đang tải...</p>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // EnhancedOthelloGame Class
        class EnhancedOthelloGame {
            constructor() {
                this.socket = null;
                this.isOnlineMode = false;
                this.isHost = false;
                this.roomId = null;
                this.currentRoomName = null; // Store display name
                this.currentPlayerName = null;
                this.board = Array(8).fill(0).map(() => Array(8).fill(0));
                this.currentPlayerTurn = 1; // 1: Black, 2: White
                this.playerColor = null; // Current player's color in online mode
                this.scores = { 1: 0, 2: 0 };
                this.validMoves = [];
                this.gameStarted = false;
                this.gameOver = false;
                this.winner = null;
                this.chatMessages = [];
                this.playersInRoom = []; // Array of { id, name, color, connected, isHost }
                this.spectatorsInRoom = [];

                this.initUI();
                this.initSocket(); // Initialize socket connection
                this.applySavedTheme();
            }

            // --- UI Management ---
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
            }

            showLoading(message = 'Đang tải...') {
                document.getElementById('loading-message').innerText = message;
                document.getElementById('loading-overlay').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }

            // Changed to use alert()
            showNotification(message, type = 'info') {
                alert(message); // Using native alert for notifications
                // Optionally, you could still add console.log for debugging purposes
                console.log(`Notification (${type}): ${message}`);
            }

            showModal(title, bodyHtml, showActionButton = false, buttonText = '', buttonAction = null) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = bodyHtml;
                const actionBtn = document.getElementById('modal-action-btn');
                if (showActionButton) {
                    actionBtn.style.display = 'block';
                    actionBtn.innerText = buttonText;
                    actionBtn.onclick = buttonAction;
                } else {
                    actionBtn.style.display = 'none';
                    actionBtn.onclick = null;
                }
                document.getElementById('game-modal').style.display = 'flex';
            }

            closeModal() {
                document.getElementById('game-modal').style.display = 'none';
            }

            // --- Theme Management ---
            applySavedTheme() {
                const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
                document.documentElement.setAttribute('data-theme', savedTheme);
                this.updateThemeToggle(savedTheme);
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateThemeToggle(newTheme);
            }

            updateThemeToggle(theme) {
                const themeIcon = document.getElementById('theme-icon');
                const themeName = document.getElementById('theme-name');
                if (theme === 'dark') {
                    themeIcon.src = 'image_79de3b.png'; // Assuming a moon/dark icon
                    themeName.innerText = 'Chủ đề tối';
                    document.documentElement.style.setProperty('--text-primary-invert-filter', '0');
                } else {
                    themeIcon.src = 'image_788ce0.png'; // Assuming a sun/light icon
                    themeName.innerText = 'Chủ đề sáng';
                    document.documentElement.style.setProperty('--text-primary-invert-filter', '1');
                }
            }

            // --- Initialization ---
            initUI() {
                // Main Menu
                document.getElementById('play-offline-btn').addEventListener('click', () => this.playOffline());
                document.getElementById('show-online-options-btn').addEventListener('click', () => this.showOnlineOptions());
                document.getElementById('show-leaderboard-btn').addEventListener('click', () => this.showLeaderboard());
                document.getElementById('show-rules-btn').addEventListener('click', () => this.showRules());

                // Online Options
                document.getElementById('create-room-btn').addEventListener('click', () => this.createRoom());
                document.getElementById('show-join-room-btn').addEventListener('click', () => this.showJoinRoom());
                document.getElementById('back-to-main-from-online').addEventListener('click', () => this.showScreen('main-menu'));

                // Join Room Screen
                document.getElementById('join-room-btn').addEventListener('click', () => this.joinRoom());
                document.getElementById('back-to-online-options').addEventListener('click', () => this.showOnlineOptions());

                // Room Info Screen
                document.getElementById('copy-room-link-btn').addEventListener('click', () => this.copyRoomLink());
                document.getElementById('start-game-btn').addEventListener('click', () => this.startGame());
                document.getElementById('send-room-chat-btn').addEventListener('click', () => this.sendChatMessage('room-chat-input', 'room-chat-messages'));
                document.getElementById('room-chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage('room-chat-input', 'room-chat-messages');
                });
                document.getElementById('leave-room-btn').addEventListener('click', () => this.leaveRoom());

                // Game Screen
                document.getElementById('restart-game-btn').addEventListener('click', () => this.resetGame());
                document.getElementById('leave-game-btn').addEventListener('click', () => this.leaveGame());
                document.getElementById('send-game-chat-btn').addEventListener('click', () => this.sendChatMessage('game-chat-input', 'game-chat-messages'));
                document.getElementById('game-chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage('game-chat-input', 'game-chat-messages');
                });

                // Leaderboard Screen
                document.getElementById('back-to-main-from-leaderboard').addEventListener('click', () => this.showScreen('main-menu'));
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                document.getElementById('refresh-room-list-btn').addEventListener('click', () => this.requestRoomList());
                document.getElementById('back-to-online-options-from-list').addEventListener('click', () => this.showOnlineOptions());


                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

                this.renderBoard();
            }

            initSocket() {
                this.socket = io(); // Connect to the server where the HTML is served

                this.socket.on('connect', () => {
                    console.log('Connected to server!');
                    this.hideLoading();
                });

                this.socket.on('disconnect', () => {
                    console.log('Disconnected from server.');
                    this.showNotification('Mất kết nối với máy chủ. Vui lòng kiểm tra internet hoặc tải lại trang.', 'error');
                    this.isOnlineMode = false;
                    this.isHost = false;
                    this.roomId = null;
                    this.currentRoomName = null;
                    this.currentPlayerName = null;
                    this.showScreen('main-menu');
                });

                this.socket.on('roomCreated', (data) => {
                    this.hideLoading();
                    this.roomId = data.roomId;
                    this.currentRoomName = data.roomName; // Set the display name
                    this.isHost = data.isHost;
                    this.isOnlineMode = true;
                    this.updateGameState(data);
                    this.updateRoomInfoDisplay();
                    document.getElementById('start-game-btn').style.display = this.isHost ? 'block' : 'none'; // Only host sees start button
                    this.showScreen('room-info-screen');
                    this.showNotification(`Đã tạo phòng thành công! ID: ${this.roomId}`, 'success');
                });

                this.socket.on('roomJoined', (gameState) => {
                    this.hideLoading();
                    this.roomId = gameState.roomId;
                    this.currentRoomName = gameState.roomName; // Set the display name
                    this.isOnlineMode = true;
                    this.updateGameState(gameState);
                    this.showScreen('game-screen'); // Show the game screen directly after joining
                    this.showNotification(`Đã tham gia phòng ${this.currentRoomName}!`, 'success');
                });

                this.socket.on('roomError', (message) => {
                    this.hideLoading();
                    this.showNotification(message, 'error');
                    // Decide where to go after an error, e.g., back to online options or main menu
                    this.showScreen('online-options-screen'); 
                });

                this.socket.on('updateRoomList', (rooms) => {
                    this.renderRoomList(rooms);
                });

                this.socket.on('playerJoined', (players) => {
                    this.playersInRoom = players;
                    this.updateRoomInfoDisplay(); // Update display for host/opponent
                    this.showNotification(`${players[players.length - 1].name} đã tham gia phòng!`, 'info');
                });

                this.socket.on('playerLeft', (players) => {
                    this.playersInRoom = players;
                    this.updateRoomInfoDisplay();
                    this.showNotification('Một người chơi đã rời phòng.', 'info');
                });

                this.socket.on('playerDisconnected', (players) => {
                    this.playersInRoom = players;
                    this.updateRoomInfoDisplay(); // Mark as disconnected
                    this.showNotification('Một người chơi đã bị ngắt kết nối.', 'info');
                });

                this.socket.on('playerReconnected', (players) => {
                    this.playersInRoom = players;
                    this.updateRoomInfoDisplay();
                    this.showNotification('Một người chơi đã kết nối lại.', 'info');
                });

                this.socket.on('gameStarted', (gameState) => {
                    this.hideLoading();
                    this.updateGameState(gameState);
                    this.showScreen('game-screen');
                    this.showNotification('Trò chơi đã bắt đầu!', 'success');
                    document.getElementById('start-game-btn').style.display = 'none'; // Hide start button
                });

                this.socket.on('boardUpdate', (gameState) => {
                    this.updateGameState(gameState);
                });

                this.socket.on('turnUpdate', (gameState) => {
                    this.updateGameState(gameState);
                });

                this.socket.on('moveError', (message) => {
                    this.showNotification(message, 'error');
                });

                this.socket.on('gameEnded', (gameState) => {
                    this.updateGameState(gameState);
                    let resultMsg = '';
                    if (gameState.winner === 0) {
                        resultMsg = 'Trò chơi hòa!';
                    } else {
                        const winnerName = gameState.players.find(p => p.color === gameState.winner)?.name || 'Người chơi không xác định';
                        resultMsg = `${winnerName} đã thắng!`;
                    }
                    this.showModal('Trò chơi kết thúc', `Kết quả: ${resultMsg}<br>Điểm Đen: ${gameState.scores[1]}, Điểm Trắng: ${gameState.scores[2]}`, true, 'Chơi Lại', () => {
                        this.closeModal();
                        this.socket.emit('requestRematch', this.roomId); // Implement rematch logic if desired
                        this.resetGame(); // Simple reset for now
                    });
                });

                this.socket.on('newChatMessage', (chatMessages) => {
                    this.chatMessages = chatMessages;
                    this.renderChatMessages('room-chat-messages');
                    this.renderChatMessages('game-chat-messages');
                });
            }

            updateGameState(gameState) {
                this.board = gameState.board;
                this.currentPlayerTurn = gameState.currentPlayer;
                this.scores = gameState.scores;
                this.validMoves = gameState.validMoves;
                this.gameStarted = gameState.gameStarted;
                this.gameOver = gameState.gameOver;
                this.winner = gameState.winner;
                this.chatMessages = gameState.chatMessages;
                this.playersInRoom = gameState.players;
                this.spectatorsInRoom = gameState.spectators;

                // Determine current player's color
                const myPlayer = this.playersInRoom.find(p => p.id === this.socket.id);
                if (myPlayer) {
                    this.playerColor = myPlayer.color;
                    this.currentPlayerName = myPlayer.name; // Ensure current player name is set
                } else if (this.spectatorsInRoom.find(s => s.id === this.socket.id)) {
                    this.playerColor = null; // Spectator
                    const mySpectator = this.spectatorsInRoom.find(s => s.id === this.socket.id);
                    this.currentPlayerName = mySpectator ? mySpectator.name : 'Khán giả';
                }
                
                this.renderBoard();
                this.updateScoresDisplay();
                this.updateTurnDisplay();
                this.renderChatMessages('room-chat-messages');
                this.renderChatMessages('game-chat-messages');
            }

            updateRoomInfoDisplay() {
                document.getElementById('current-room-id').innerText = this.roomId;
                document.getElementById('display-room-name').innerText = this.currentRoomName; // Use currentRoomName
                document.getElementById('your-player-name').innerText = this.currentPlayerName;

                const hostPlayer = this.playersInRoom.find(p => p.isHost);
                document.getElementById('host-name-display').innerText = hostPlayer ? hostPlayer.name : 'Chưa xác định';

                const opponentPlayer = this.playersInRoom.find(p => !p.isHost && p.name !== this.currentPlayerName);
                if (opponentPlayer) {
                    document.getElementById('opponent-name-display').innerText = `${opponentPlayer.name} (${opponentPlayer.connected ? 'Đã kết nối' : 'Đã ngắt kết nối'})`;
                } else {
                    document.getElementById('opponent-name-display').innerText = 'Đang chờ...';
                }

                // Show/hide start button for host only
                document.getElementById('start-game-btn').style.display = (this.isHost && this.playersInRoom.length === 2 && !this.gameStarted) ? 'block' : 'none';
            }

            // --- Game Logic (Client-side simulation/display) ---
            renderBoard() {
                const boardElement = document.getElementById('game-board');
                boardElement.innerHTML = ''; // Clear previous board
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        const pieceValue = this.board[r][c];
                        if (pieceValue === 1) {
                            const piece = document.createElement('div');
                            piece.classList.add('piece', 'black');
                            cell.appendChild(piece);
                        } else if (pieceValue === 2) {
                            const piece = document.createElement('div');
                            piece.classList.add('piece', 'white');
                            cell.appendChild(piece);
                        }

                        // Add valid move indicator if it's current player's turn and a valid move
                        const isValid = this.validMoves.some(move => move.r === r && move.c === c);
                        const isMyTurn = (this.playerColor === this.currentPlayerTurn && this.playerColor !== null); // Ensure playerColor is set and not null (for spectators)

                        if (this.isOnlineMode && isMyTurn && isValid && this.gameStarted && !this.gameOver) {
                            const indicator = document.createElement('div');
                            indicator.classList.add('valid-move-indicator');
                            cell.appendChild(indicator);
                            cell.addEventListener('click', () => this.makeMove(r, c));
                        } else if (!this.isOnlineMode && isValid && this.gameStarted && !this.gameOver) {
                            // Offline mode click handling
                            const indicator = document.createElement('div');
                            indicator.classList.add('valid-move-indicator');
                            cell.appendChild(indicator);
                            cell.addEventListener('click', () => this.makeMoveOffline(r, c)); // Using separate handler for offline
                        } else if (this.board[r][c] === 0) {
                            cell.classList.add('invalid-move'); // Visual cue for invalid empty cells
                        }
                        boardElement.appendChild(cell);
                    }
                }
            }

            updateScoresDisplay() {
                document.getElementById('black-score').innerText = this.scores[1];
                document.getElementById('white-score').innerText = this.scores[2];
            }

            updateTurnDisplay() {
                let turnText = '';
                if (this.gameOver) {
                    if (this.winner === 0) {
                        turnText = 'Hòa!';
                    } else {
                        const winnerName = this.playersInRoom.find(p => p.color === this.winner)?.name || (this.winner === 1 ? 'Đen' : 'Trắng');
                        turnText = `${winnerName} thắng!`;
                    }
                } else if (!this.gameStarted) {
                    turnText = 'Đang chờ bắt đầu...';
                } else {
                    const currentPlayerObj = this.playersInRoom.find(p => p.color === this.currentPlayerTurn);
                    const currentPlayerName = currentPlayerObj ? currentPlayerObj.name : (this.currentPlayerTurn === 1 ? 'Đen' : 'Trắng');
                    turnText = `Lượt ${currentPlayerName} (${this.currentPlayerTurn === 1 ? 'Đen' : 'Trắng'})`;
                }
                
                const currentTurnElement = document.getElementById('current-turn');
                currentTurnElement.innerText = turnText;
                // Add/remove indicator for current player's turn
                if (this.isOnlineMode && this.playerColor === this.currentPlayerTurn && this.gameStarted && !this.gameOver) {
                    currentTurnElement.classList.add('current-turn-indicator');
                } else {
                    currentTurnElement.classList.remove('current-turn-indicator');
                }
            }

            renderChatMessages(elementId) {
                const chatBox = document.getElementById(elementId);
                chatBox.innerHTML = '';
                this.chatMessages.forEach(msg => {
                    const msgElement = document.createElement('p');
                    msgElement.classList.add('chat-message');
                    msgElement.innerHTML = `<strong>${msg.sender}:</strong> ${msg.message}`;
                    chatBox.appendChild(msgElement);
                });
                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to bottom
            }

            renderRoomList(rooms) {
                const roomListElement = document.getElementById('rooms-list');
                roomListElement.innerHTML = '';
                if (rooms.length === 0) {
                    roomListElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Chưa có phòng nào hoạt động.</p>';
                    return;
                }
                rooms.forEach(room => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('room-item');
                    listItem.innerHTML = `
                        <span>Phòng: ${room.name} (${room.players}/2)</span>
                        <button data-room-id="${room.id}" data-room-name="${room.name}">Tham Gia</button>
                    `;
                    listItem.querySelector('button').addEventListener('click', (e) => {
                        document.getElementById('join-player-name-input').value = this.currentPlayerName || ''; // Pre-fill if already known
                        document.getElementById('room-id-input').value = e.target.dataset.roomId;
                        this.showJoinRoom();
                    });
                    roomListElement.appendChild(listItem);
                });
            }
            
            // --- Game Actions ---
            playOffline() {
                this.isOnlineMode = false;
                this.isHost = false; // Not relevant for offline
                this.roomId = null;
                this.currentRoomName = 'Offline Game';
                this.currentPlayerName = 'Người chơi'; // Default name for offline
                this.resetGame();
                this.showScreen('game-screen');
            }

            resetGame() {
                this.board = Array(8).fill(0).map(() => Array(8).fill(0));
                this.board[3][3] = 2; // White
                this.board[3][4] = 1; // Black
                this.board[4][3] = 1; // Black
                this.board[4][4] = 2; // White
                this.currentPlayerTurn = 1;
                this.scores = { 1: 2, 2: 2 }; // Initial scores
                this.gameStarted = true; // Offline game starts immediately
                this.gameOver = false;
                this.winner = null;
                this.chatMessages = []; // Clear chat for new game
                this.playerColor = 1; // For offline, assume player is Black
                this.validMoves = this.getValidMovesOffline(this.currentPlayerTurn); // Calculate initial valid moves

                document.getElementById('restart-game-btn').style.display = 'block'; // Show restart button
                document.getElementById('leave-game-btn').innerText = 'Kết Thúc Game'; // Reset text
                this.renderBoard();
                this.updateScoresDisplay();
                this.updateTurnDisplay();
                this.renderChatMessages('game-chat-messages');
            }

            makeMoveOffline(r, c) {
                if (!this.gameStarted || this.gameOver) return;

                if (!this.isValidMoveOffline(r, c, this.currentPlayerTurn)) {
                    this.showNotification('Nước đi không hợp lệ!', 'error');
                    return;
                }

                this.makeMoveLogicOffline(r, c, this.currentPlayerTurn);
                this.updateScoresDisplay();

                if (!this.checkGameEndOffline()) {
                    this.switchPlayerOffline();
                    this.validMoves = this.getValidMovesOffline(this.currentPlayerTurn);
                    this.updateTurnDisplay();
                    // If current player has no moves, switch again
                    if (this.validMoves.length === 0 && !this.gameOver) {
                        this.showNotification(`Người chơi ${this.currentPlayerTurn === 1 ? 'Đen' : 'Trắng'} không có nước đi. Chuyển lượt!`, 'info');
                        this.switchPlayerOffline();
                        this.validMoves = this.getValidMovesOffline(this.currentPlayerTurn);
                        this.updateTurnDisplay();
                        if (this.validMoves.length === 0) {
                            // Still no moves, game ends
                            this.checkGameEndOffline(); // This will set game over
                        }
                    }
                }
                this.renderBoard();
            }

            // Othello Game Logic (Offline) - Duplicated for clarity with client-side only processing
            getValidMovesOffline(playerColor) {
                const validMoves = [];
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.board[r][c] === 0 && this.isValidMoveOffline(r, c, playerColor)) {
                            validMoves.push({ r, c });
                        }
                    }
                }
                return validMoves;
            }

            isValidMoveOffline(r, c, playerColor) {
                if (this.board[r][c] !== 0) return false;

                const opponentColor = playerColor === 1 ? 2 : 1;
                const directions = [
                    [-1, 0], [1, 0], [0, -1], [0, 1], // Cardinal
                    [-1, -1], [-1, 1], [1, -1], [1, 1]  // Diagonal
                ];

                for (const [dr, dc] of directions) {
                    let foundOpponent = false;
                    let currentR = r + dr;
                    let currentC = c + dc;

                    while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                        if (this.board[currentR][currentC] === opponentColor) {
                            foundOpponent = true;
                        } else if (this.board[currentR][currentC] === playerColor && foundOpponent) {
                            return true;
                        } else {
                            break;
                        }
                        currentR += dr;
                        currentC += dc;
                    }
                }
                return false;
            }

            makeMoveLogicOffline(r, c, playerColor) {
                this.board[r][c] = playerColor;
                const opponentColor = playerColor === 1 ? 2 : 1;
                const directions = [
                    [-1, 0], [1, 0], [0, -1], [0, 1],
                    [-1, -1], [-1, 1], [1, -1], [1, 1]
                ];

                for (const [dr, dc] of directions) {
                    let lineToFlip = [];
                    let currentR = r + dr;
                    let currentC = c + dc;

                    while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                        if (this.board[currentR][currentC] === opponentColor) {
                            lineToFlip.push({ r: currentR, c: currentC });
                        } else if (this.board[currentR][currentC] === playerColor) {
                            for (const { r: flipR, c: flipC } of lineToFlip) {
                                this.board[flipR][flipC] = playerColor;
                            }
                            break;
                        } else {
                            break;
                        }
                        currentR += dr;
                        currentC += dc;
                    }
                }
                this.updateScoresOffline();
            }

            updateScoresOffline() {
                let blackCount = 0;
                let whiteCount = 0;
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.board[r][c] === 1) blackCount++;
                        else if (this.board[r][c] === 2) whiteCount++;
                    }
                }
                this.scores[1] = blackCount;
                this.scores[2] = whiteCount;
            }

            switchPlayerOffline() {
                this.currentPlayerTurn = this.currentPlayerTurn === 1 ? 2 : 1;
            }

            checkGameEndOffline() {
                const movesForBlack = this.getValidMovesOffline(1).length;
                const movesForWhite = this.getValidMovesOffline(2).length;

                if (movesForBlack === 0 && movesForWhite === 0) {
                    this.gameOver = true;
                    if (this.scores[1] > this.scores[2]) {
                        this.winner = 1;
                        this.showModal('Trò chơi kết thúc', `Đen thắng! Điểm: Đen ${this.scores[1]} - Trắng ${this.scores[2]}`, true, 'Chơi Lại', () => {
                            this.closeModal();
                            this.resetGame();
                        });
                    } else if (this.scores[2] > this.scores[1]) {
                        this.winner = 2;
                        this.showModal('Trò chơi kết thúc', `Trắng thắng! Điểm: Đen ${this.scores[1]} - Trắng ${this.scores[2]}`, true, 'Chơi Lại', () => {
                            this.closeModal();
                            this.resetGame();
                        });
                    } else {
                        this.winner = 0; // Tie
                        this.showModal('Trò chơi kết thúc', `Hòa! Điểm: Đen ${this.scores[1]} - Trắng ${this.scores[2]}`, true, 'Chơi Lại', () => {
                            this.closeModal();
                            this.resetGame();
                        });
                    }
                    this.updateTurnDisplay(); // Update display to show winner
                    document.getElementById('restart-game-btn').innerText = 'Chơi Lại';
                    return true;
                }
                return false;
            }

            makeMove(r, c) {
                if (this.isOnlineMode && this.socket && this.roomId) {
                    this.socket.emit('makeMove', { roomId: this.roomId, r, c });
                } else {
                    this.showNotification('Không thể di chuyển: Không ở chế độ online hoặc không có phòng.', 'error');
                }
            }
            
            leaveGame() {
                if (this.isOnlineMode && this.socket && this.roomId) {
                    this.showNotification('Rời khỏi game online. Bạn vẫn ở trong phòng.', 'info');
                    this.showScreen('room-info-screen'); // Go back to room info screen
                    this.resetGame(); // Reset game state locally
                    // Do NOT emit 'leaveRoom' here, as that leaves the room entirely.
                    // If you want to only leave the game but stay in room, backend needs 'leaveGame' event.
                    // For now, it just resets client side game state and goes back to room info.
                } else {
                    this.showNotification('Rời khỏi game offline.', 'info');
                    this.showScreen('main-menu');
                    this.resetGame(); // Reset game state for next offline game
                }
            }

            // --- Online Room Actions ---
            showOnlineOptions() {
                this.showScreen('online-options-screen');
                // Clear inputs when showing online options
                document.getElementById('player-name-input').value = '';
                document.getElementById('room-name-input').value = '';
            }

            createRoom() {
                const roomNameInput = document.getElementById('room-name-input');
                const roomName = roomNameInput.value.trim();
                const playerNameInput = document.getElementById('player-name-input');
                const playerName = playerNameInput.value.trim();

                if (roomName && playerName) {
                    this.showLoading('Đang tạo phòng...');
                    this.socket.emit('createRoom', { roomName, playerName });
                    this.currentPlayerName = playerName;
                } else if (playerName) {
                     this.showLoading('Đang tạo phòng...');
                     // If roomName is empty, send an empty string or null, backend will use generated ID as display name
                    this.socket.emit('createRoom', { roomName: '', playerName }); 
                    this.currentPlayerName = playerName;
                }
                else {
                    this.showNotification('Vui lòng nhập Tên người chơi và Tên phòng (tùy chọn)!', 'error');
                }
            }

            showJoinRoom() {
                this.showScreen('join-room-screen');
                // Clear player name input for new joins
                document.getElementById('join-player-name-input').value = ''; 
                // room-id-input might be pre-filled from URL, so don't clear it.
            }

            joinRoom() {
                const roomIdInput = document.getElementById('room-id-input');
                const roomId = roomIdInput.value.trim();
                const playerNameInput = document.getElementById('join-player-name-input');
                const playerName = playerNameInput.value.trim();

                if (roomId && playerName) {
                    this.showLoading(`Đang tham gia phòng ${roomId}...`);
                    this.socket.emit('joinRoom', { roomId, playerName });
                    this.currentPlayerName = playerName; // Set current player name immediately
                } else {
                    this.showNotification('Vui lòng nhập Tên người chơi và ID phòng!', 'error');
                }
            }

            copyRoomLink() {
                if (this.roomId) {
                    const roomLink = `${window.location.origin}?room=${this.roomId}`;
                    navigator.clipboard.writeText(roomLink).then(() => {
                        this.showNotification('Đã sao chép link phòng!', 'success');
                    }).catch(err => {
                        console.error('Không thể sao chép link:', err);
                        this.showNotification('Không thể sao chép link. Vui lòng sao chép thủ công: ' + roomLink, 'error');
                    });
                }
            }

            startGame() {
                if (this.isHost && this.roomId && this.playersInRoom.length === 2) {
                    this.showLoading('Đang bắt đầu trò chơi...');
                    this.socket.emit('startGame', { roomId: this.roomId });
                } else if (!this.isHost) {
                    this.showNotification('Chỉ chủ phòng mới có thể bắt đầu trò chơi.', 'error');
                } else if (this.playersInRoom.length < 2) {
                    this.showNotification('Cần 2 người chơi để bắt đầu trò chơi.', 'error');
                }
            }

            leaveRoom() {
                if (this.socket && this.roomId) {
                    this.socket.emit('leaveRoom');
                    this.showLoading('Đang rời phòng...');
                    this.isOnlineMode = false;
                    this.isHost = false;
                    this.roomId = null;
                    this.currentRoomName = null;
                    this.currentPlayerName = null;
                    this.playersInRoom = [];
                    this.spectatorsInRoom = [];
                    this.resetGame(); // Reset game state when leaving room
                    this.showScreen('main-menu');
                    this.showNotification('Đã rời phòng thành công.', 'info');
                }
            }

            requestRoomList() {
                this.showLoading('Đang tải danh sách phòng...');
                // You might need an API endpoint for this if Socket.IO isn't suitable for initial list fetch
                // For now, assume backend sends 'updateRoomList' on connect/refresh
                this.socket.emit('requestRoomList'); // Need to add this event on backend if not existing
                // Or just show the screen and wait for the periodic updateRoomList from server
                this.showScreen('room-list-screen');
                // Backend needs to emit 'updateRoomList' on 'requestRoomList' event.
            }

            sendChatMessage(inputId, messagesId) {
                const inputElement = document.getElementById(inputId);
                const message = inputElement.value.trim();
                if (message && this.roomId && this.socket) {
                    this.socket.emit('chatMessage', { roomId: this.roomId, message });
                    inputElement.value = '';
                }
            }

            showLeaderboard() {
                this.showLoading('Đang tải bảng xếp hạng...');
                fetch('/api/leaderboard')
                    .then(response => response.json())
                    .then(data => {
                        this.renderLeaderboard(data);
                        this.showScreen('leaderboard-screen');
                        this.hideLoading();
                        this.switchTab('ratings'); // Show ratings tab by default
                    })
                    .catch(error => {
                        console.error('Error fetching leaderboard:', error);
                        this.showNotification('Không thể tải bảng xếp hạng.', 'error');
                        this.hideLoading();
                    });
            }

            renderLeaderboard(leaderData) {
                const tbody = document.getElementById('leaderboard-table').querySelector('tbody');
                tbody.innerHTML = '';
                if (leaderData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Chưa có dữ liệu xếp hạng.</td></tr>';
                    return;
                }
                leaderData.forEach((player, index) => {
                    const row = tbody.insertRow();
                    row.insertCell().innerText = index + 1;
                    row.insertCell().innerText = player.name;
                    row.insertCell().innerText = player.rating.toFixed(0);
                    row.insertCell().innerText = player.wins;
                    row.insertCell().innerText = player.losses;
                });
            }

            renderStats(statsData) {
                const tbody = document.getElementById('stats-table').querySelector('tbody');
                tbody.innerHTML = '';
                if (statsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Chưa có dữ liệu thống kê.</td></tr>';
                    return;
                }
                statsData.forEach(player => {
                    const row = tbody.insertRow();
                    row.insertCell().innerText = player.name;
                    row.insertCell().innerText = player.totalGames;
                    row.insertCell().innerText = player.wins;
                    row.insertCell().innerText = player.losses;
                    row.insertCell().innerText = player.ties;
                    row.insertCell().innerText = player.pointsScored;
                    row.insertCell().innerText = player.pointsConceded;
                });
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');

                document.querySelectorAll('.tab-content .screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Load data for the selected tab
                if (tabName === 'stats') {
                    this.showLoading('Đang tải thống kê...');
                    fetch('/api/stats') // Assuming an endpoint for all player stats
                        .then(response => response.json())
                        .then(data => {
                            this.renderStats(data);
                            this.hideLoading();
                        })
                        .catch(error => {
                            console.error('Error fetching stats:', error);
                            this.showNotification('Không thể tải thống kê.', 'error');
                            this.hideLoading();
                        });
                } else if (tabName === 'ratings') {
                    this.showLeaderboard(); // Re-fetch leaderboard for ratings
                }
            }

            showRules() {
                this.showModal('Luật Chơi Cờ Lật (Othello/Reversi)', `
                    <div class="rules-content">
                        <ul>
                            <li>Mục tiêu: Đặt các quân cờ của bạn (Đen hoặc Trắng) để có nhiều quân cờ hơn đối thủ khi bàn cờ đầy hoặc không thể di chuyển nữa.</li>
                            <li>Bắt đầu: Bàn cờ 8x8 bắt đầu với 2 quân đen và 2 quân trắng ở giữa bàn cờ, theo hình chữ X.</li>
                            <li>Lượt đi: Người chơi Đen đi trước.</li>
                            <li>Cách di chuyển:
                                <ul>
                                    <li>Bạn phải đặt một quân cờ của mình vào một ô trống sao cho có ít nhất một quân cờ của đối thủ bị kẹp giữa quân cờ mới đặt và một quân cờ khác của bạn (theo chiều ngang, dọc hoặc chéo).</li>
                                    <li>Tất cả các quân cờ của đối thủ bị kẹp giữa hai quân cờ của bạn sẽ bị "lật" và đổi thành màu của bạn.</li>
                                    <li>Bạn phải thực hiện một nước đi lật ít nhất một quân cờ.</li>
                                    <li>Nếu bạn không có nước đi hợp lệ, lượt sẽ tự động chuyển sang đối thủ.</li>
                                </ul>
                            </li>
                            <li>Kết thúc trò chơi: Trò chơi kết thúc khi:
                                <ul>
                                    <li>Bàn cờ đầy (64 ô đều có quân cờ).</li>
                                    <li>Không người chơi nào có nước đi hợp lệ.</li>
                                </ul>
                            </li>
                            <li>Tính điểm: Người chơi có nhiều quân cờ hơn trên bàn cờ sẽ thắng. Nếu số quân bằng nhau, trò chơi hòa.</li>
                        </ul>
                    </div>
                `, false);
            }
        }

        let game; // Declare game globally

        // Helper functions (could be part of the class or external)
        function playOffline() {
            game.playOffline();
        }

        function showOnlineOptions() {
            game.showOnlineOptions();
        }

        function createRoom() {
            game.createRoom();
        }

        function showJoinRoom() {
            game.showJoinRoom();
        }

        function joinRoom() {
            game.joinRoom();
        }

        function copyRoomLink() {
            game.copyRoomLink();
        }

        function startGame() {
            game.startGame();
        }

        function showLeaderboard() {
            game.showLeaderboard();
        }

        function leaveRoom() {
            game.leaveRoom();
        }

        function leaveGame() {
            game.leaveGame();
        }

        function resetGame() {
            game.resetGame();
        }

        function showRules() {
            game.showRules();
        }

        function closeModal() {
            game.closeModal();
        }

        function sendChatMessage() {
            // This is handled by specific chat inputs now
        }

        function switchTab(tabName) {
            game.switchTab(tabName);
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', () => {
            game = new EnhancedOthelloGame();
            
            // Check for room ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) {
                document.getElementById('room-id-input').value = roomId;
                game.showScreen('join-room-screen'); // Show join room screen
                // Pre-fill player name if it was saved in localStorage or derived
                const savedPlayerName = localStorage.getItem('playerName'); // Example of saving/loading player name
                if (savedPlayerName) {
                    document.getElementById('join-player-name-input').value = savedPlayerName;
                }
                // No automatic join, user has to click "Join" after entering name
            } else {
                game.showScreen('main-menu'); // Show main menu if no room ID in URL
            }
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (game && game.isOnlineMode && game.socket) {
                if (document.hidden) {
                    // Page hidden - potentially disconnect or set status as away
                    // game.socket.disconnect(); // You might want to disconnect explicitly
                } else {
                    // Page visible - reconnect if needed
                    if (game.socket.disconnected) {
                        game.socket.connect();
                        // Attempt to rejoin room if was in one
                        if (game.roomId && game.currentPlayerName) {
                            game.socket.emit('reconnectAttempt', { roomId: game.roomId, playerName: game.currentPlayerName });
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
