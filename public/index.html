<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cờ Lật Online - Enhanced Multiplayer Othello</title>
    <style>
        :root {
            /* Default Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: white;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --accent-color: #FFD700;
            --success-color: #00ff88;
            --error-color: #ff6b6b;
            --board-bg: #2d3748;
            --cell-bg: #4a5568;
            --cell-hover: #718096;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(0, 0, 0, 0.3);
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --accent-color: #f39c12;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --board-bg: #34495e;
            --cell-bg: #4a6582;
            --cell-hover: #5d7a96;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            background-color: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            width: 800px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin: 20px 0;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1.1em;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin: 0 5px;
        }

        .tab-button.active {
            color: var(--accent-color);
            background-color: rgba(255, 255, 255, 0.15);
            border-bottom: 3px solid var(--accent-color);
        }

        .tab-button:hover:not(.active) {
            color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
            padding: 15px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Home Tab */
        .home-options button {
            background-color: var(--accent-color);
            color: black;
            border: none;
            padding: 12px 25px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .home-options button:hover {
            background-color: #FFC000;
            transform: translateY(-2px);
        }

        .mode-selection {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .mode-selection button {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 2px solid var(--accent-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .mode-selection button.active {
            background-color: var(--accent-color);
            color: black;
            border-color: var(--accent-color);
        }

        .mode-selection button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2);
        }


        /* Online Lobby */
        .lobby-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .lobby-controls input[type="text"] {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            font-size: 1em;
            width: 200px;
        }

        .lobby-controls button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .lobby-controls button.create {
            background-color: var(--success-color);
            color: black;
        }

        .lobby-controls button.join {
            background-color: var(--accent-color);
            color: black;
        }

        .lobby-controls button:hover {
            opacity: 0.9;
        }

        .room-list-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-top: 20px;
        }

        .room-list-container h3 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        #room-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #room-list li {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        #room-list li span {
            margin-right: 10px;
        }

        #room-list li button {
            background-color: var(--accent-color);
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #room-list li button:hover {
            background-color: #FFC000;
        }

        /* Game Board */
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .player-score {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-score.active-turn {
            color: var(--accent-color);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .player-score .token {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid var(--text-primary);
            display: inline-block;
        }

        .player-score .token.black {
            background-color: black;
        }

        .player-score .token.white {
            background-color: white;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 480px; /* 8 * 60px */
            height: 480px;
            background-color: var(--board-bg);
            border-radius: 10px;
            border: 5px solid var(--accent-color);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .cell {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background-color: var(--cell-bg);
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative; /* For possible moves */
        }

        .cell:hover:not(.occupied):not(.invalid) {
            background-color: var(--cell-hover);
        }

        .cell.highlight {
            background-color: var(--success-color); /* Highlight valid moves */
            box-shadow: inset 0 0 10px rgba(0, 255, 136, 0.7);
        }
        
        .token {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .token.black {
            background-color: black;
            color: white;
        }

        .token.white {
            background-color: white;
            color: black;
        }

        .token.flipping {
            animation: flip 0.5s forwards;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); background-color: grey; }
            100% { transform: rotateY(180deg); }
        }

        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .game-controls button {
            background-color: var(--accent-color);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .game-controls button:hover {
            background-color: #FFC000;
        }

        .online-status {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .online-status.connected {
            color: var(--success-color);
        }

        .online-status.disconnected {
            color: var(--error-color);
        }

        /* Chat */
        .chat-container {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            max-height: 350px;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 10px;
            word-wrap: break-word; /* Ensure long words wrap */
            white-space: pre-wrap; /* Preserve whitespace and wrap */
            text-align: left;
        }

        .chat-message {
            margin-bottom: 8px;
        }

        .chat-message strong {
            color: var(--accent-color);
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: auto; /* Push to bottom */
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            font-size: 1em;
        }

        .chat-input button {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--success-color);
            color: black;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .chat-input button:hover {
            opacity: 0.9;
        }

        /* Leaderboard */
        .leaderboard-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .leaderboard-container h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            text-align: center;
        }

        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-secondary);
        }

        #leaderboard-table th, #leaderboard-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        #leaderboard-table th {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        /* Rules Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: auto;
            padding: 25px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: left;
            color: var(--text-secondary);
        }

        .modal-content h2 {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-content ul {
            list-style-type: decimal;
            margin-left: 20px;
            padding-left: 0;
        }

        .modal-content li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .close-button {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--error-color);
            text-decoration: none;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--accent-color);
            color: var(--text-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 100;
        }

        .theme-toggle:hover {
            background-color: rgba(0, 0, 0, 0.6);
            transform: translateY(-2px);
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .board {
                width: 320px; /* 8 * 40px */
                height: 320px;
            }

            .home-options button,
            .lobby-controls button {
                width: 100%;
                margin: 5px 0;
            }

            .lobby-controls {
                flex-direction: column;
                align-items: center;
            }

            .lobby-controls input[type="text"] {
                width: 90%;
            }
        }

        @media (max-width: 480px) {
            .board {
                width: 240px; /* 8 * 30px */
                height: 240px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cờ Lật Online</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('home')">Trang chủ</button>
            <button class="tab-button" onclick="switchTab('lobby')">Phòng chờ</button>
            <button class="tab-button" onclick="switchTab('game')">Ván đấu</button>
            <button class="tab-button" onclick="switchTab('chat')">Trò chuyện</button>
            <button class="tab-button" onclick="switchTab('leaderboard')">Bảng xếp hạng</button>
        </div>

        <div id="home-tab" class="tab-content active">
            <h2>Chào mừng đến với Othello!</h2>
            <div class="mode-selection">
                <button id="offline-mode-btn" class="active">Chơi Offline</button>
                <button id="online-mode-btn">Chơi Online</button>
            </div>
            <div class="home-options">
                <button onclick="startGame()">Bắt đầu trò chơi mới</button>
                <button onclick="showRules()">Luật chơi</button>
            </div>
        </div>

        <div id="lobby-tab" class="tab-content">
            <h2>Phòng chờ trực tuyến</h2>
            <div class="lobby-controls">
                <input type="text" id="player-name-input" placeholder="Nhập tên người chơi của bạn" />
                <input type="text" id="room-id-input" placeholder="Nhập ID phòng" />
                <button class="create" onclick="createRoom()">Tạo phòng</button>
                <button class="join" onclick="joinRoom()">Tham gia phòng</button>
            </div>
            <p id="room-error-message" style="color: var(--error-color);"></p>
            <div class="online-status" id="connection-status">Đang kết nối...</div>

            <div class="room-list-container">
                <h3>Các phòng đang hoạt động:</h3>
                <ul id="room-list">
                    <li>Không có phòng nào đang hoạt động.</li>
                </ul>
            </div>
        </div>

        <div id="game-tab" class="tab-content">
            <h2>Trò chơi Othello</h2>
            <div class="game-area">
                <div class="game-info">
                    <span id="player-black-score" class="player-score black">
                        <span class="token black"></span> Đen: <span id="score-black">2</span>
                    </span>
                    <span id="turn-indicator">Đến lượt: Đen</span>
                    <span id="player-white-score" class="player-score white">
                        Trắng: <span id="score-white">2</span> <span class="token white"></span>
                    </span>
                </div>
                <div class="board" id="game-board">
                    </div>
                <p id="game-message" style="color: var(--accent-color); font-weight: bold; margin-top: 10px;"></p>
                <div class="game-controls">
                    <button onclick="resetGame()">Chơi lại</button>
                    <button onclick="leaveRoom()">Rời phòng</button>
                    <button onclick="leaveGame()">Về màn hình chính</button>
                </div>
            </div>
        </div>

        <div id="chat-tab" class="tab-content">
            <h2>Trò chuyện trong phòng</h2>
            <div class="chat-container">
                <div id="chat-messages">
                    </div>
                <div class="chat-input">
                    <input type="text" id="chat-message-input" placeholder="Nhập tin nhắn..." />
                    <button onclick="sendChatMessage()">Gửi</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-tab" class="tab-content">
            <h2>Bảng xếp hạng</h2>
            <div class="leaderboard-container">
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Hạng</th>
                            <th>Tên người chơi</th>
                            <th>Điểm ELO</th>
                            <th>Thắng</th>
                            <th>Thua</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5">Đang tải bảng xếp hạng...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2>Luật chơi Othello (Reversi)</h2>
            <ul>
                <li>Mục tiêu là có nhiều quân cờ của mình hơn đối thủ khi bàn cờ đầy hoặc không thể di chuyển hợp lệ.</li>
                <li>Trò chơi bắt đầu với 4 quân cờ ở giữa bàn cờ: 2 đen và 2 trắng.</li>
                <li>Người chơi Đen đi trước.</li>
                <li>Bạn phải đặt một quân cờ ở ô trống sao cho nó bao vây (theo chiều ngang, dọc, hoặc chéo) ít nhất một quân cờ của đối thủ giữa quân cờ bạn vừa đặt và một quân cờ khác của bạn đã có sẵn.</li>
                <li>Tất cả các quân cờ của đối thủ bị bao vây sẽ bị "lật" thành màu của bạn.</li>
                <li>Nếu không có nước đi hợp lệ nào, lượt chơi sẽ chuyển sang cho đối thủ. Nếu cả hai người chơi đều không có nước đi hợp lệ, trò chơi kết thúc.</li>
                <li>Trò chơi cũng kết thúc khi bàn cờ đầy.</li>
                <li>Người chơi có nhiều quân cờ hơn sẽ thắng.</li>
            </ul>
        </div>
    </div>

    <button class="theme-toggle" id="theme-toggle">&#9728;</button> <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        let game; // Declare game globally

        // Basic Othello game logic (simplified for demonstration)
        class OthelloGame {
            constructor() {
                this.board = Array(8).fill(0).map(() => Array(8).fill(0)); // 0: empty, 1: black, -1: white
                this.currentPlayer = 1; // 1 for black, -1 for white
                this.initializeBoard();
            }

            initializeBoard() {
                this.board[3][3] = -1; // White
                this.board[3][4] = 1;  // Black
                this.board[4][3] = 1;  // Black
                this.board[4][4] = -1; // White
            }

            // ... (Other game logic like isValidMove, flipTokens, calculateScore) ...
            // Bạn sẽ cần thêm các phương thức logic game đầy đủ ở đây
        }

        class EnhancedOthelloGame extends OthelloGame {
            constructor() {
                super();
                this.isOnlineMode = false;
                this.playerName = '';
                this.roomId = '';
                this.socket = null; // Khởi tạo null, sẽ được gán trong initializeConnection
                
                // ĐẢM BẢO CÓ DÒNG NÀY ĐỂ GỌI HÀM KHỞI TẠO KẾT NỐI
                this.initializeConnection(); 
                this.setupEventListeners();
                this.loadTheme();
                this.switchTab('home'); // Bắt đầu ở tab Home
                this.setupModeSelection(); // Thiết lập nút Offline/Online
                this.renderBoard();
                this.updateScoresDisplay();
                this.updateTurnIndicator();
                this.updateConnectionStatus('disconnected'); // Trạng thái ban đầu
            }

            // (ĐÃ CHỈNH SỬA) Logic khởi tạo kết nối Socket.IO
            initializeConnection() {
                try {
                    if (!this.socket) { // Đảm bảo chỉ khởi tạo một lần
                        // ĐẢM BẢO ĐÂY LÀ URL ĐÚNG CỦA SERVER RENDER CỦA BẠN
                        this.socket = io("https://huongcute.onrender.com");

                        // THÊM HOẶC CẬP NHẬT CÁC SỰ KIỆN KẾT NỐI TẠI ĐÂY ĐỂ DEBUG
                        this.socket.on('connect', () => {
                            console.log('Successfully connected to Socket.IO server!');
                            this.updateConnectionStatus('connected');
                            this.isOnlineMode = true;
                            // Sau khi kết nối, có thể yêu cầu danh sách phòng hoặc tự động tham gia nếu có roomId
                            this.socket.emit('requestRoomList'); 
                        });

                        this.socket.on('disconnect', (reason) => {
                            console.log('Disconnected from Socket.IO server:', reason);
                            this.updateConnectionStatus('disconnected');
                            this.isOnlineMode = false;
                            // Xử lý khi ngắt kết nối (ví dụ: hiển thị thông báo)
                            if (reason === 'io server disconnect') {
                                // Server đã chủ động ngắt kết nối
                                alert('Server disconnected. Please refresh.');
                            } else if (reason === 'ping timeout') {
                                alert('Connection timed out. Please check your internet.');
                            } else if (reason === 'transport close') {
                                console.log('Transport closed.');
                            } else if (reason === 'transport error') {
                                console.error('Transport error:', reason.description);
                            }
                        });

                        this.socket.on('connect_error', (error) => {
                            console.error('Socket.IO connection error:', error.message);
                            this.updateConnectionStatus('disconnected');
                            this.isOnlineMode = false;
                            alert('Failed to connect to game server. Please try again later.');
                        });

                        // Gọi hàm liên kết các sự kiện khác của game (đảm bảo hàm này đã tồn tại và xử lý các sự kiện game)
                        this.bindSocketEvents(); 
                    }
                } catch (error) {
                    // Nếu 'io' không được định nghĩa, tức là thư viện Socket.IO client chưa được tải đúng cách
                    console.error('Error initializing Socket.io library (io() not found or other error):', error);
                    console.log('Socket.io library might not be loaded, running in offline mode');
                    this.updateConnectionStatus('disconnected');
                    this.isOnlineMode = false;
                    alert('Lỗi tải thư viện game trực tuyến. Vui lòng tải lại trang.');
                }
            }
            
            // Các sự kiện socket.on khác của game (ĐÃ ĐẢM BẢO ĐƯỢC GIỮ NGUYÊN HOẶC CẬP NHẬT THEO SERVER)
            bindSocketEvents() {
                this.socket.on('updateRoomList', (rooms) => {
                    const roomListElement = document.getElementById('room-list');
                    roomListElement.innerHTML = ''; // Clear existing list
                    if (rooms.length === 0) {
                        roomListElement.innerHTML = '<li>Không có phòng nào đang hoạt động.</li>';
                        return;
                    }
                    rooms.forEach(room => {
                        const li = document.createElement('li');
                        const playersText = room.players.length > 0 ? `(${room.players.map(p => p.name).join(', ')})` : '(Trống)';
                        li.innerHTML = `
                            <span>Phòng: <strong>${room.id}</strong> - Người chơi: ${playersText} - Trạng thái: ${room.state || 'chờ'}</span>
                            <button onclick="game.joinRoomById('${room.id}')">Tham gia</button>
                        `;
                        roomListElement.appendChild(li);
                    });
                });

                this.socket.on('roomCreated', (gameState) => {
                    this.roomId = gameState.roomId;
                    console.log(`Room created: ${this.roomId}`);
                    this.updateGame(gameState);
                    this.switchTab('game');
                    this.displayGameMessage(`Phòng "${this.roomId}" đã được tạo. Chờ người chơi khác...`);
                });

                this.socket.on('playerJoined', (gameState) => {
                    this.roomId = gameState.roomId;
                    console.log('Player joined:', gameState.players);
                    this.updateGame(gameState);
                    this.switchTab('game'); // Chuyển sang tab game nếu chưa ở đó
                    this.displayGameMessage(`Người chơi "${gameState.players[gameState.players.length-1].name}" đã tham gia.`);
                });
                
                this.socket.on('joinedAsSpectator', (gameState) => {
                    this.roomId = gameState.roomId;
                    console.log('Joined as spectator:', gameState.players);
                    this.updateGame(gameState);
                    this.switchTab('game'); // Chuyển sang tab game nếu chưa ở đó
                    this.displayGameMessage(`Bạn đã tham gia phòng "${this.roomId}" với tư cách khán giả.`);
                });


                this.socket.on('playerLeft', (gameState) => {
                    console.log('Player left. Current players:', gameState.players);
                    this.updateGame(gameState);
                    this.displayGameMessage('Một người chơi đã rời khỏi phòng.');
                });

                this.socket.on('hostDisconnected', (gameState) => {
                    console.log('Host disconnected. Game may end or new host chosen.');
                    this.updateGame(gameState);
                    this.displayGameMessage('Chủ phòng đã ngắt kết nối. Game có thể sẽ kết thúc.');
                });

                this.socket.on('playerDisconnected', ({ playerName, roomState }) => {
                    console.log(`${playerName} disconnected.`);
                    this.updateGame(roomState);
                    this.displayGameMessage(`${playerName} đã ngắt kết nối.`);
                });

                this.socket.on('roomError', (message) => {
                    document.getElementById('room-error-message').textContent = message;
                    setTimeout(() => {
                        document.getElementById('room-error-message').textContent = '';
                    }, 5000);
                });

                this.socket.on('gameStateUpdate', (gameState) => {
                    this.updateGame(gameState);
                });

                this.socket.on('newChatMessage', (message) => {
                    this.addChatMessage(message.playerName, message.message, message.timestamp);
                });
                // Dòng này cần được cập nhật để lấy dữ liệu từ server của bạn
                // this.socket.on('leaderboardUpdate', (data) => {
                //     // Cập nhật bảng xếp hạng
                // });
            }

            setupEventListeners() {
                // Event listeners for game elements
                const gameBoard = document.getElementById('game-board');
                if (gameBoard) {
                    gameBoard.addEventListener('click', (event) => {
                        const cell = event.target.closest('.cell');
                        if (cell) {
                            const row = parseInt(cell.dataset.row);
                            const col = parseInt(cell.dataset.col);
                            this.handleCellClick(row, col);
                        }
                    });
                }

                document.getElementById('offline-mode-btn').addEventListener('click', () => {
                    this.setOnlineMode(false);
                });
                document.getElementById('online-mode-btn').addEventListener('click', () => {
                    this.setOnlineMode(true);
                });
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
            }

            setupModeSelection() {
                const offlineBtn = document.getElementById('offline-mode-btn');
                const onlineBtn = document.getElementById('online-mode-btn');

                offlineBtn.addEventListener('click', () => {
                    this.setOnlineMode(false);
                    offlineBtn.classList.add('active');
                    onlineBtn.classList.remove('active');
                    this.switchTab('home'); // Về tab home khi chuyển mode
                });

                onlineBtn.addEventListener('click', () => {
                    this.setOnlineMode(true);
                    onlineBtn.classList.add('active');
                    offlineBtn.classList.remove('active');
                    this.switchTab('lobby'); // Chuyển sang tab lobby khi chuyển online
                });

                // Set initial active button
                if (this.isOnlineMode) {
                    onlineBtn.classList.add('active');
                    offlineBtn.classList.remove('active');
                } else {
                    offlineBtn.classList.add('active');
                    onlineBtn.classList.remove('active');
                }
            }

            setOnlineMode(isOnline) {
                this.isOnlineMode = isOnline;
                console.log(`Online mode: ${this.isOnlineMode}`);
                if (this.isOnlineMode && (!this.socket || this.socket.disconnected)) {
                    this.initializeConnection(); // Kết nối lại nếu đang ở chế độ online và chưa kết nối
                } else if (!this.isOnlineMode && this.socket && this.socket.connected) {
                    // Nếu chuyển sang offline mode và đang kết nối, có thể ngắt kết nối socket nếu muốn
                    // this.socket.disconnect();
                }
            }


            // Game board rendering
            renderBoard() {
                const boardElement = document.getElementById('game-board');
                boardElement.innerHTML = ''; // Clear previous board
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        const token = document.createElement('div');
                        token.classList.add('token');
                        if (this.board[r][c] === 1) {
                            token.classList.add('black');
                        } else if (this.board[r][c] === -1) {
                            token.classList.add('white');
                        }
                        cell.appendChild(token);
                        boardElement.appendChild(cell);
                    }
                }
            }

            updateGame(gameState) {
                // Cập nhật trạng thái game từ server
                this.board = gameState.board;
                this.currentPlayer = gameState.turn;
                this.renderBoard();
                this.updateScoresDisplay();
                this.updateTurnIndicator();
                // Hiển thị người chơi trong phòng
                const playerNames = gameState.players.map(p => `${p.name} (${p.connected ? 'online' : 'offline'})`).join(', ');
                this.displayGameMessage(`Người chơi: ${playerNames}`);
            }

            updateScoresDisplay() {
                const scores = this.calculateScore();
                document.getElementById('score-black').textContent = scores.black;
                document.getElementById('score-white').textContent = scores.white;

                const playerBlackScoreElem = document.getElementById('player-black-score');
                const playerWhiteScoreElem = document.getElementById('player-white-score');

                playerBlackScoreElem.classList.remove('active-turn');
                playerWhiteScoreElem.classList.remove('active-turn');

                if (this.currentPlayer === 1) { // Black's turn
                    playerBlackScoreElem.classList.add('active-turn');
                } else { // White's turn
                    playerWhiteScoreElem.classList.add('active-turn');
                }
            }

            updateTurnIndicator() {
                const turnIndicator = document.getElementById('turn-indicator');
                turnIndicator.textContent = `Đến lượt: ${this.currentPlayer === 1 ? 'Đen' : 'Trắng'}`;
            }

            displayGameMessage(message) {
                document.getElementById('game-message').textContent = message;
            }

            // Game logic methods (to be filled or completed)
            isValidMove(row, col, player) {
                // Placeholder for actual Othello move validation
                // This would involve checking all 8 directions for flips
                return this.board[row][col] === 0; // Simplified: just check if empty
            }

            handleCellClick(row, col) {
                if (!this.isOnlineMode) {
                    // Logic for offline game
                    if (this.isValidMove(row, col, this.currentPlayer)) {
                        this.board[row][col] = this.currentPlayer;
                        // this.flipTokens(row, col, this.currentPlayer); // Placeholder
                        this.currentPlayer *= -1; // Switch turn
                        this.renderBoard();
                        this.updateScoresDisplay();
                        this.updateTurnIndicator();
                    } else {
                        this.displayGameMessage("Nước đi không hợp lệ!");
                    }
                } else {
                    // Logic for online game
                    if (this.socket && this.socket.connected) {
                        // Gửi nước đi lên server
                        this.socket.emit('makeMove', { roomId: this.roomId, move: { row, col } });
                    } else {
                        this.displayGameMessage("Bạn không kết nối đến server!");
                    }
                }
            }

            calculateScore() {
                let black = 0;
                let white = 0;
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.board[r][c] === 1) {
                            black++;
                        } else if (this.board[r][c] === -1) {
                            white++;
                        }
                    }
                }
                return { black, white };
            }

            startGame() {
                this.board = Array(8).fill(0).map(() => Array(8).fill(0));
                this.initializeBoard();
                this.currentPlayer = 1;
                this.renderBoard();
                this.updateScoresDisplay();
                this.updateTurnIndicator();
                this.displayGameMessage("");
                this.switchTab('game');
                // Nếu đang online, tạo phòng mới
                if (this.isOnlineMode) {
                    this.showCreateRoom(); // Chuyển sang giao diện tạo phòng
                }
            }

            resetGame() {
                this.board = Array(8).fill(0).map(() => Array(8).fill(0));
                this.initializeBoard();
                this.currentPlayer = 1;
                this.renderBoard();
                this.updateScoresDisplay();
                this.updateTurnIndicator();
                this.displayGameMessage("Trò chơi đã được đặt lại.");
            }

            // Online game functions
            showCreateRoom() {
                this.switchTab('lobby'); // Chuyển sang tab lobby
                document.getElementById('room-error-message').textContent = '';
            }

            showJoinRoom() {
                this.switchTab('lobby'); // Chuyển sang tab lobby
                document.getElementById('room-error-message').textContent = '';
            }

            createRoom() {
                this.playerName = document.getElementById('player-name-input').value.trim();
                this.roomId = document.getElementById('room-id-input').value.trim();

                if (!this.playerName) {
                    document.getElementById('room-error-message').textContent = 'Vui lòng nhập tên người chơi.';
                    return;
                }
                if (!this.roomId) {
                    document.getElementById('room-error-message').textContent = 'Vui lòng nhập ID phòng.';
                    return;
                }
                document.getElementById('room-error-message').textContent = '';

                if (this.socket && this.socket.connected) {
                    this.socket.emit('createRoom', { roomId: this.roomId, playerName: this.playerName });
                } else {
                    document.getElementById('room-error-message').textContent = 'Không kết nối được đến server Socket.IO.';
                }
            }

            joinRoom() {
                this.playerName = document.getElementById('player-name-input').value.trim();
                this.roomId = document.getElementById('room-id-input').value.trim();

                if (!this.playerName) {
                    document.getElementById('room-error-message').textContent = 'Vui lòng nhập tên người chơi.';
                    return;
                }
                if (!this.roomId) {
                    document.getElementById('room-error-message').textContent = 'Vui lòng nhập ID phòng.';
                    return;
                }
                document.getElementById('room-error-message').textContent = '';

                if (this.socket && this.socket.connected) {
                    this.socket.emit('joinRoom', { roomId: this.roomId, playerName: this.playerName });
                } else {
                    document.getElementById('room-error-message').textContent = 'Không kết nối được đến server Socket.IO.';
                }
            }

            joinRoomById(roomId) {
                // Hàm tiện ích để tham gia phòng từ danh sách
                this.playerName = document.getElementById('player-name-input').value.trim();
                if (!this.playerName) {
                    alert('Vui lòng nhập tên người chơi của bạn vào ô "Tên người chơi" trước khi tham gia phòng.');
                    this.switchTab('lobby'); // Chuyển về tab lobby để người dùng nhập tên
                    return;
                }
                document.getElementById('room-id-input').value = roomId; // Điền Room ID vào input
                this.joinRoom(); // Gọi hàm joinRoom
            }

            leaveRoom() {
                if (this.socket && this.socket.connected && this.roomId) {
                    this.socket.emit('leaveRoom');
                    this.roomId = '';
                    this.switchTab('lobby'); // Về lại phòng chờ
                    this.displayGameMessage("");
                    alert('Bạn đã rời phòng.');
                } else {
                    this.displayGameMessage("Bạn không ở trong phòng trực tuyến.");
                    this.switchTab('lobby');
                }
            }

            leaveGame() {
                // Dùng để rời khỏi bàn cờ và quay về trang chính hoặc phòng chờ
                if (this.isOnlineMode && this.roomId) {
                    this.leaveRoom(); // Rời phòng nếu đang ở chế độ online
                }
                this.switchTab('home');
                this.displayGameMessage("");
                this.resetGame(); // Đặt lại trạng thái game cục bộ
            }

            sendChatMessage() {
                const chatInput = document.getElementById('chat-message-input');
                const message = chatInput.value.trim();
                if (message && this.socket && this.socket.connected && this.roomId && this.playerName) {
                    this.socket.emit('chatMessage', { roomId: this.roomId, playerName: this.playerName, message: message });
                    chatInput.value = '';
                } else {
                    alert('Vui lòng tham gia phòng và nhập tên người chơi để trò chuyện.');
                }
            }

            addChatMessage(playerName, message, timestamp) {
                const chatMessagesElem = document.getElementById('chat-messages');
                const messageElem = document.createElement('div');
                messageElem.classList.add('chat-message');
                messageElem.innerHTML = `<strong>[${timestamp}] ${playerName}:</strong> ${message}`;
                chatMessagesElem.appendChild(messageElem);
                chatMessagesElem.scrollTop = chatMessagesElem.scrollHeight; // Scroll to bottom
            }

            // UI and Utility functions
            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                document.getElementById(`${tabName}-tab`).classList.add('active');
                document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');

                // Load leaderboard when switching to its tab
                if (tabName === 'leaderboard') {
                    this.loadLeaderboardData();
                }
            }

            async loadLeaderboardData() {
                try {
                    // ĐẢM BẢO ĐÂY LÀ URL ĐÚNG CỦA SERVER RENDER CỦA BẠN
                    const response = await fetch('https://huongcute.onrender.com/api/leaderboard'); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const leaderboardData = await response.json();
                    const tableBody = document.querySelector('#leaderboard-table tbody');
                    tableBody.innerHTML = ''; // Clear existing rows

                    if (leaderboardData.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5">Không có dữ liệu bảng xếp hạng.</td></tr>';
                        return;
                    }

                    leaderboardData.forEach((player, index) => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = index + 1;
                        row.insertCell().textContent = player.name;
                        row.insertCell().textContent = player.rating || 'N/A';
                        row.insertCell().textContent = player.wins || 0;
                        row.insertCell().textContent = player.losses || 0;
                    });

                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    document.querySelector('#leaderboard-table tbody').innerHTML = '<tr><td colspan="5" style="color:var(--error-color);">Không thể tải bảng xếp hạng. Vui lòng thử lại.</td></tr>';
                }
            }

            // ĐÃ THÊM HOẶC CẬP NHẬT HÀM NÀY ĐỂ HIỂN THỊ TRẠNG THÁI KẾT NỐI
            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) { // Đảm bảo phần tử tồn tại trước khi cập nhật
                    statusElement.textContent = `Trạng thái: ${status === 'connected' ? 'Đã kết nối' : 'Đã ngắt kết nối'}`;
                    statusElement.className = `online-status ${status}`;
                }
            }

            showRules() {
                document.getElementById('rules-modal').style.display = 'flex';
            }

            closeModal() {
                document.getElementById('rules-modal').style.display = 'none';
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    this.updateThemeToggleIcon(savedTheme);
                }
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateThemeToggleIcon(newTheme);
            }

            updateThemeToggleIcon(theme) {
                const toggleButton = document.getElementById('theme-toggle');
                toggleButton.innerHTML = theme === 'dark' ? '&#9790;' : '&#9728;'; // Moon for dark, Sun for light
            }
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', () => {
            game = new EnhancedOthelloGame();
            
            // Check for room ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) {
                document.getElementById('room-id-input').value = roomId;
                // Thay đổi từ game.showJoinRoom() sang thông báo và để người dùng tự nhấn Join
                game.switchTab('lobby'); 
                game.displayGameMessage(`Bạn có thể tham gia phòng "${roomId}". Vui lòng nhập tên và nhấn "Tham gia".`);
            }
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (game && game.isOnlineMode && game.socket) {
                if (document.hidden) {
                    // Page hidden
                } else {
                    // Page visible - reconnect if needed
                    if (game.socket.disconnected) {
                        console.log('Page became visible, attempting to reconnect socket...');
                        game.socket.connect(); // Attempt to reconnect
                    }
                }
            }
        });

        // Global functions (for onclick in HTML)
        function startGame() { game.startGame(); }
        function createRoom() { game.createRoom(); }
        function joinRoom() { game.joinRoom(); }
        function leaveRoom() { game.leaveRoom(); }
        function leaveGame() { game.leaveGame(); }
        function resetGame() { game.resetGame(); }
        function showRules() { game.showRules(); }
        function closeModal() { game.closeModal(); }
        function sendChatMessage() { game.sendChatMessage(); }
        function switchTab(tabName) { game.switchTab(tabName); }
    </script>
</body>
</html>
