<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        class EnhancedOthelloGame {
            constructor() {
                // Đảm bảo URL kết nối Socket.IO là 'https://huongcute.onrender.com'
                // Đây là dòng bạn cần thay đổi/kiểm tra
                this.socket = io('https://huongcute.onrender.com');

                // Khởi tạo các thuộc tính khác của game (ví dụ: board, currentPlayer, etc.)
                this.board = Array(8).fill(null).map(() => Array(8).fill(0));
                this.board[3][3] = 1; // Quân trắng
                this.board[3][4] = 2; // Quân đen
                this.board[4][3] = 2; // Quân đen
                this.board[4][4] = 1; // Quân trắng
                this.currentPlayer = 2; // Quân đen bắt đầu
                this.isOnlineMode = false;
                this.roomId = null;
                this.playerName = "Người chơi";
                this.playerColor = null;
                this.opponentName = null;
                this.gameActive = false;
                this.isAIGame = false;
                this.aiDifficulty = 'medium'; // Mặc định độ khó trung bình
                this.validMoves = new Map(); // Lưu trữ các nước đi hợp lệ
                this.theme = localStorage.getItem('theme') || 'default'; // Lấy theme từ localStorage hoặc mặc định

                // Cập nhật theme khi khởi tạo game
                document.body.setAttribute('data-theme', this.theme);
                this.updateThemeOptions();

                // Tham chiếu đến các phần tử UI
                this.boardElement = document.getElementById('board');
                this.currentPlayerElement = document.getElementById('current-player');
                this.blackScoreElement = document.getElementById('black-score');
                this.whiteScoreElement = document.getElementById('white-score');
                this.messageElement = document.getElementById('game-message');
                this.onlinePlayersElement = document.getElementById('online-players-count');
                this.roomListElement = document.getElementById('room-list');
                this.player1NameElement = document.getElementById('player1-name');
                this.player2NameElement = document.getElementById('player2-name');
                this.player1ColorElement = document.getElementById('player1-color');
                this.player2ColorElement = document.getElementById('player2-color');
                this.turnIndicatorElement = document.getElementById('turn-indicator');
                this.onlineRoomIdElement = document.getElementById('online-room-id');
                this.leaveRoomButton = document.getElementById('leave-room-btn');
                this.resetGameButton = document.getElementById('reset-game-btn');
                this.gameArea = document.getElementById('game-area');
                this.mainMenu = document.getElementById('main-menu');
                this.joinRoomMenu = document.getElementById('join-room-menu');
                this.aiMenu = document.getElementById('ai-menu');
                this.leaderboardTableBody = document.getElementById('leaderboard-table-body');
                this.statsWins = document.getElementById('stats-wins');
                this.statsLosses = document.getElementById('stats-losses');
                this.statsDraws = document.getElementById('stats-draws');
                this.statsOnlineGames = document.getElementById('stats-online-games');
                this.statsOfflineGames = document.getElementById('stats-offline-games');
                this.statsMovesPlayed = document.getElementById('stats-moves-played');
                this.statsDiscsFlipped = document.getElementById('stats-discs-flipped');

                // Sự kiện Socket.IO
                this.setupSocketEvents();

                // Tạo bảng cờ
                this.createBoard();
                this.updateBoard(); // Cập nhật lần đầu
                this.updateScores();
                this.updatePlayerInfoDisplay();

                // Xử lý sự kiện click trên bảng
                this.boardElement.addEventListener('click', this.handleBoardClick.bind(this));

                // Khởi tạo tab
                this.setupTabs();

                // Load player name từ localStorage
                const savedPlayerName = localStorage.getItem('playerName');
                if (savedPlayerName) {
                    this.playerName = savedPlayerName;
                    document.getElementById('player-name').value = savedPlayerName;
                } else {
                    this.promptForPlayerName();
                }

                this.showMainMenu();
            }

            // =====================================
            // CÁC PHƯƠNG THỨC CỦA LỚP ENHANCEDOTHELLOGAME
            // (Bạn sẽ dán toàn bộ các hàm/phương thức đã có của bạn vào đây)
            // =====================================

            // Ví dụ một số phương thức cơ bản (bạn hãy thay thế bằng code của mình)
            showGameScreen() {
                this.mainMenu.style.display = 'none';
                this.joinRoomMenu.style.display = 'none';
                this.aiMenu.style.display = 'none';
                this.gameArea.style.display = 'flex'; // Sử dụng flexbox cho gameArea
                document.getElementById('game-screen-tabs').style.display = 'flex';
                document.getElementById('game-footer').style.display = 'flex';
            }

            showMainMenu() {
                this.mainMenu.style.display = 'block';
                this.joinRoomMenu.style.display = 'none';
                this.aiMenu.style.display = 'none';
                this.gameArea.style.display = 'none';
                document.getElementById('game-screen-tabs').style.display = 'none';
                document.getElementById('game-footer').style.display = 'none';
                this.resetGameState();
                this.socket.emit('requestRoomList');
            }

            showJoinRoom() {
                this.mainMenu.style.display = 'none';
                this.joinRoomMenu.style.display = 'block';
                this.aiMenu.style.display = 'none';
                this.gameArea.style.display = 'none';
                document.getElementById('game-screen-tabs').style.display = 'none';
                document.getElementById('game-footer').style.display = 'none';
                this.socket.emit('requestRoomList');
            }

            showAIMenu() {
                this.mainMenu.style.display = 'none';
                this.joinRoomMenu.style.display = 'none';
                this.aiMenu.style.display = 'block';
                this.gameArea.style.display = 'none';
                document.getElementById('game-screen-tabs').style.display = 'none';
                document.getElementById('game-footer').style.display = 'none';
            }

            createRoom(mode) {
                this.playerName = document.getElementById('player-name').value.trim();
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên người chơi của bạn!', 'error');
                    return;
                }
                localStorage.setItem('playerName', this.playerName);
                this.isOnlineMode = true;
                this.isAIGame = false;
                this.socket.emit('createRoom', { playerName: this.playerName, mode: mode });
            }

            joinRoom() {
                this.playerName = document.getElementById('player-name').value.trim();
                const roomIdInput = document.getElementById('room-id-input').value.trim();
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên người chơi của bạn!', 'error');
                    return;
                }
                if (!roomIdInput) {
                    this.showToast('Vui lòng nhập ID phòng!', 'error');
                    return;
                }
                localStorage.setItem('playerName', this.playerName);
                this.isOnlineMode = true;
                this.isAIGame = false;
                this.socket.emit('joinRoom', { roomId: roomIdInput, playerName: this.playerName });
            }

            leaveRoom() {
                if (confirm('Bạn có chắc muốn rời phòng? Nếu rời khi game đang diễn ra, bạn sẽ bị tính thua.')) {
                    this.socket.emit('leaveRoom', { roomId: this.roomId, socketId: this.socket.id });
                    this.showMainMenu();
                    this.showToast('Đã rời phòng.', 'info');
                }
            }

            playOffline() {
                this.playerName = document.getElementById('player-name').value.trim();
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên người chơi của bạn!', 'error');
                    return;
                }
                localStorage.setItem('playerName', this.playerName);
                this.isOnlineMode = false;
                this.isAIGame = false; // Chế độ offline 2 người
                this.resetGameState();
                this.startGame();
                this.showGameScreen();
                this.updatePlayerInfoDisplay(); // Hiển thị tên người chơi offline
            }

            createAIRoom() {
                this.playerName = document.getElementById('player-name').value.trim();
                const aiDifficulty = document.querySelector('input[name="ai-difficulty"]:checked').value;
                if (!this.playerName) {
                    this.showToast('Vui lòng nhập tên người chơi của bạn!', 'error');
                    return;
                }
                localStorage.setItem('playerName', this.playerName);
                this.isOnlineMode = false; // Game AI không phải online mode
                this.isAIGame = true;
                this.aiDifficulty = aiDifficulty;
                this.resetGameState();
                this.startGame();
                this.showGameScreen();
                this.updatePlayerInfoDisplay(); // Hiển thị tên người chơi và AI
            }

            startGame() {
                this.gameActive = true;
                this.updateBoard();
                this.updateScores();
                this.messageElement.textContent = 'Trò chơi bắt đầu!';
                this.calculateValidMoves();
                this.renderValidMoves();
                this.updateTurnIndicator();

                if (this.isAIGame && this.currentPlayer === 1) { // AI luôn là quân Trắng (1)
                    setTimeout(() => this.makeAIMove(), 1000);
                }
            }

            resetGame() {
                if (confirm('Bạn có chắc muốn chơi lại?')) {
                    this.resetGameState();
                    this.startGame();
                    this.showToast('Trò chơi đã được reset!', 'info');
                }
            }

            resetGameState() {
                this.board = Array(8).fill(null).map(() => Array(8).fill(0));
                this.board[3][3] = 1;
                this.board[3][4] = 2;
                this.board[4][3] = 2;
                this.board[4][4] = 1;
                this.currentPlayer = 2; // Luôn bắt đầu với quân đen
                this.validMoves.clear();
                this.gameActive = false;
                this.messageElement.textContent = '';
                this.opponentName = null;
                this.playerColor = null;
                this.player1NameElement.textContent = 'Người chơi Đen';
                this.player2NameElement.textContent = 'Người chơi Trắng';
                this.player1ColorElement.className = 'color-box black';
                this.player2ColorElement.className = 'color-box white';
                this.onlineRoomIdElement.textContent = '';
                this.leaveRoomButton.style.display = 'none';
                this.resetGameButton.style.display = 'none';
                this.updateBoard();
                this.updateScores();
                this.updateTurnIndicator();
                this.clearValidMovesHighlight();
            }

            updateBoard() {
                this.boardElement.innerHTML = ''; // Xóa bảng hiện tại
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        const disc = document.createElement('div');
                        disc.classList.add('disc');
                        if (this.board[r][c] === 1) {
                            disc.classList.add('white');
                        } else if (this.board[r][c] === 2) {
                            disc.classList.add('black');
                        } else {
                            disc.style.visibility = 'hidden'; // Ẩn đĩa nếu không có quân
                        }
                        cell.appendChild(disc);
                        this.boardElement.appendChild(cell);
                    }
                }
            }

            updateScores() {
                let blackCount = 0;
                let whiteCount = 0;
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.board[r][c] === 1) {
                            whiteCount++;
                        } else if (this.board[r][c] === 2) {
                            blackCount++;
                        }
                    }
                }
                this.blackScoreElement.textContent = blackCount;
                this.whiteScoreElement.textContent = whiteCount;
                return { black: blackCount, white: whiteCount };
            }

            updatePlayerInfoDisplay() {
                if (this.isOnlineMode) {
                    this.player1NameElement.textContent = this.playerColor === 2 ? this.playerName : this.opponentName || 'Đang chờ...';
                    this.player2NameElement.textContent = this.playerColor === 1 ? this.playerName : this.opponentName || 'Đang chờ...';
                    this.player1ColorElement.className = 'color-box black';
                    this.player2ColorElement.className = 'color-box white';
                    this.leaveRoomButton.style.display = 'inline-block';
                    this.resetGameButton.style.display = 'none'; // Chỉ hiển thị khi game có host
                    this.onlineRoomIdElement.textContent = `Phòng: ${this.roomId}`;
                } else if (this.isAIGame) {
                    this.player1NameElement.textContent = this.playerName;
                    this.player2NameElement.textContent = `Máy (${this.aiDifficulty})`;
                    this.player1ColorElement.className = 'color-box black';
                    this.player2ColorElement.className = 'color-box white';
                    this.leaveRoomButton.style.display = 'none';
                    this.resetGameButton.style.display = 'inline-block';
                    this.onlineRoomIdElement.textContent = 'Chơi với máy';
                } else { // Offline 2 người
                    this.player1NameElement.textContent = this.playerName; // Player 1 là Người chơi
                    this.player2NameElement.textContent = 'Người chơi 2';
                    this.player1ColorElement.className = 'color-box black';
                    this.player2ColorElement.className = 'color-box white';
                    this.leaveRoomButton.style.display = 'none';
                    this.resetGameButton.style.display = 'inline-block';
                    this.onlineRoomIdElement.textContent = 'Chơi Offline';
                }
            }

            updateTurnIndicator() {
                const indicatorText = this.currentPlayer === 2 ? 'Lượt Đen' : 'Lượt Trắng';
                this.turnIndicatorElement.textContent = indicatorText;
                this.turnIndicatorElement.className = `turn-indicator ${this.currentPlayer === 2 ? 'black-turn' : 'white-turn'}`;
            }

            getOpponentColor(player) {
                return player === 1 ? 2 : 1;
            }

            isValidMove(r, c, player) {
                if (this.board[r][c] !== 0) return false;

                const opponent = this.getOpponentColor(player);
                let isValid = false;

                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;

                        let currentR = r + dr;
                        let currentC = c + dc;
                        let foundOpponent = false;
                        let pathLength = 0;

                        while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                            if (this.board[currentR][currentC] === opponent) {
                                foundOpponent = true;
                                pathLength++;
                            } else if (this.board[currentR][currentC] === player) {
                                if (foundOpponent && pathLength > 0) {
                                    isValid = true;
                                }
                                break;
                            } else {
                                break; // Ô trống hoặc ngoài biên
                            }
                            currentR += dr;
                            currentC += dc;
                        }
                    }
                }
                return isValid;
            }

            calculateValidMoves() {
                this.validMoves.clear();
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.isValidMove(r, c, this.currentPlayer)) {
                            this.validMoves.set(`${r},${c}`, true);
                        }
                    }
                }
            }

            renderValidMoves() {
                this.clearValidMovesHighlight(); // Xóa highlight cũ
                this.validMoves.forEach((_, key) => {
                    const [r, c] = key.split(',').map(Number);
                    const cell = this.boardElement.children[r * 8 + c];
                    if (cell) {
                        cell.classList.add('valid-move');
                    }
                });
            }

            clearValidMovesHighlight() {
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('valid-move');
                });
            }

            flipDiscs(r, c, player) {
                const opponent = this.getOpponentColor(player);
                let discsFlippedCount = 0;

                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;

                        let currentR = r + dr;
                        let currentC = c + dc;
                        let discsToFlip = [];

                        while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                            if (this.board[currentR][currentC] === opponent) {
                                discsToFlip.push({ r: currentR, c: currentC });
                            } else if (this.board[currentR][currentC] === player) {
                                for (const disc of discsToFlip) {
                                    this.board[disc.r][disc.c] = player;
                                    discsFlippedCount++;
                                }
                                break;
                            } else {
                                break; // Ô trống hoặc ngoài biên
                            }
                            currentR += dr;
                            currentC += dc;
                        }
                    }
                }
                return discsFlippedCount;
            }

            handleBoardClick(event) {
                if (!this.gameActive) return;

                const cell = event.target.closest('.cell');
                if (!cell) return;

                const r = parseInt(cell.dataset.row);
                const c = parseInt(cell.dataset.col);

                if (this.isOnlineMode) {
                    // Trong online mode, chỉ người chơi đến lượt và là quân của mình mới được đi
                    if (this.currentPlayer !== this.playerColor) {
                        this.showToast('Không phải lượt của bạn!', 'error');
                        return;
                    }
                    if (!this.validMoves.has(`${r},${c}`)) {
                        this.showToast('Nước đi không hợp lệ!', 'error');
                        return;
                    }
                    this.socket.emit('makeMove', { roomId: this.roomId, row: r, col: c });
                } else { // Offline hoặc AI mode
                    if (!this.validMoves.has(`${r},${c}`)) {
                        this.showToast('Nước đi không hợp lệ!', 'error');
                        return;
                    }
                    this.makeMove(r, c);
                }
            }

            makeMove(r, c) {
                if (!this.gameActive) return;

                this.board[r][c] = this.currentPlayer;
                const flippedCount = this.flipDiscs(r, c, this.currentPlayer);
                this.updateBoard();
                const scores = this.updateScores();

                // Cập nhật thống kê di chuyển và số đĩa lật
                gameStats.set('totalMovesPlayed', (gameStats.get('totalMovesPlayed') || 0) + 1);
                gameStats.set('totalDiscsFlipped', (gameStats.get('totalDiscsFlipped') || 0) + flippedCount);

                this.clearValidMovesHighlight();
                this.nextTurn(scores);
            }

            nextTurn(scores) {
                this.currentPlayer = this.getOpponentColor(this.currentPlayer);
                this.calculateValidMoves();
                this.renderValidMoves();
                this.updateTurnIndicator();

                if (this.validMoves.size === 0) {
                    // Kiểm tra xem người chơi tiếp theo có nước đi nào không
                    const nextPlayer = this.getOpponentColor(this.currentPlayer);
                    this.currentPlayer = nextPlayer; // Tạm thời chuyển lượt để kiểm tra nước đi
                    this.calculateValidMoves();
                    if (this.validMoves.size === 0) {
                        this.endGame(scores); // Không ai có thể đi, kết thúc game
                    } else {
                        // Người chơi hiện tại không có nước đi, nhưng đối thủ có. Bỏ qua lượt.
                        this.messageElement.textContent = `Người chơi ${this.getDiscColorName(this.getOpponentColor(nextPlayer))} không có nước đi. Lượt của ${this.getDiscColorName(nextPlayer)}.`;
                        // Cập nhật lại currentPlayer về đúng người chơi có lượt
                        this.currentPlayer = nextPlayer;
                        this.renderValidMoves();
                        this.updateTurnIndicator();
                        if (this.isAIGame && this.currentPlayer === 1) { // Nếu bỏ qua lượt của AI
                             setTimeout(() => this.makeAIMove(), 1000);
                        } else if (this.isOnlineMode && this.playerColor === this.currentPlayer) {
                            this.showToast('Bạn không có nước đi. Lượt đã được chuyển cho đối thủ.', 'info');
                        }
                    }
                } else {
                    if (this.isAIGame && this.currentPlayer === 1) { // AI là quân Trắng (1)
                        setTimeout(() => this.makeAIMove(), 1000);
                    } else if (this.isOnlineMode && this.playerColor === this.currentPlayer) {
                        this.showToast('Đến lượt bạn!', 'info');
                    }
                }
            }

            endGame(scores) {
                this.gameActive = false;
                this.clearValidMovesHighlight();
                let winnerMessage = '';
                let outcome = ''; // 'win', 'loss', 'draw'

                if (scores.black > scores.white) {
                    winnerMessage = 'Người chơi Đen thắng!';
                    if (this.isOnlineMode) {
                        outcome = this.playerColor === 2 ? 'win' : 'loss';
                    } else if (this.isAIGame) {
                        outcome = this.playerName === this.player1NameElement.textContent ? 'win' : 'loss';
                    }
                } else if (scores.white > scores.black) {
                    winnerMessage = 'Người chơi Trắng thắng!';
                    if (this.isOnlineMode) {
                        outcome = this.playerColor === 1 ? 'win' : 'loss';
                    } else if (this.isAIGame) {
                        outcome = this.playerName === this.player2NameElement.textContent ? 'win' : 'loss';
                    }
                } else {
                    winnerMessage = 'Hòa!';
                    outcome = 'draw';
                }
                this.messageElement.textContent = `Trò chơi kết thúc! ${winnerMessage}`;
                this.showToast(`Trò chơi kết thúc! ${winnerMessage}`, 'success');

                if (this.isOnlineMode) {
                    this.socket.emit('gameEnded', {
                        roomId: this.roomId,
                        winnerColor: scores.black > scores.white ? 2 : (scores.white > scores.black ? 1 : 0), // 0 for draw
                        finalScores: scores
                    });
                } else {
                    // Cập nhật thống kê cho game offline/AI
                    this.updateLocalStats(outcome);
                    this.resetGameButton.style.display = 'inline-block';
                }
            }

            updateLocalStats(outcome) {
                switch (outcome) {
                    case 'win':
                        gameStats.set('wins', (gameStats.get('wins') || 0) + 1);
                        break;
                    case 'loss':
                        gameStats.set('losses', (gameStats.get('losses') || 0) + 1);
                        break;
                    case 'draw':
                        gameStats.set('draws', (gameStats.get('draws') || 0) + 1);
                        break;
                }
                if (this.isAIGame) {
                    gameStats.set('aiGames', (gameStats.get('aiGames') || 0) + 1);
                } else {
                    gameStats.set('offlineGames', (gameStats.get('offlineGames') || 0) + 1);
                }
                this.saveLocalStats();
            }

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            getDiscColorName(color) {
                return color === 1 ? 'Trắng' : 'Đen';
            }

            // =====================================
            // CÁC PHƯƠNG THỨC SOCKET.IO
            // =====================================
            setupSocketEvents() {
                this.socket.on('connect', () => {
                    console.log('Connected to server!');
                    this.showToast('Đã kết nối đến máy chủ!', 'success');
                    this.socket.emit('requestRoomList');
                    this.socket.emit('requestOnlinePlayersCount');
                });

                this.socket.on('disconnect', () => {
                    console.log('Disconnected from server!');
                    this.showToast('Mất kết nối với máy chủ!', 'error');
                });

                this.socket.on('onlinePlayersCount', (count) => {
                    this.onlinePlayersElement.textContent = count;
                });

                this.socket.on('roomCreated', (room) => {
                    this.roomId = room.id;
                    this.playerColor = 2; // Người tạo phòng luôn là quân Đen
                    this.isOnlineMode = true;
                    this.isAIGame = false;
                    this.resetGameState();
                    this.updatePlayerInfoDisplay();
                    this.showGameScreen();
                    this.showToast(`Phòng đã tạo! ID: ${room.id}. Chờ người chơi khác...`, 'info');
                    this.messageElement.textContent = 'Đang chờ người chơi khác tham gia...';
                    this.leaveRoomButton.style.display = 'inline-block'; // Hiển thị nút rời phòng
                });

                this.socket.on('roomJoined', (data) => {
                    this.roomId = data.roomId;
                    this.playerColor = data.playerColor;
                    this.opponentName = data.opponentName;
                    this.isOnlineMode = true;
                    this.isAIGame = false;
                    this.resetGameState();
                    this.updatePlayerInfoDisplay();
                    this.showGameScreen();
                    this.showToast(`Đã tham gia phòng ${data.roomId}!`, 'success');
                    this.messageElement.textContent = `Bạn là quân ${this.getDiscColorName(this.playerColor)}. Sẵn sàng chơi!`;
                    this.leaveRoomButton.style.display = 'inline-block';
                    // Nếu bạn là người chơi thứ 2, cập nhật game ngay lập tức
                    if (data.board) {
                        this.board = data.board;
                        this.currentPlayer = data.currentPlayer;
                        this.gameActive = data.gameActive;
                        this.updateBoard();
                        this.updateScores();
                        this.updateTurnIndicator();
                        this.calculateValidMoves();
                        this.renderValidMoves();
                    }
                });

                this.socket.on('roomFull', () => {
                    this.showToast('Phòng đã đầy hoặc không tồn tại!', 'error');
                });

                this.socket.on('playerJoined', (data) => {
                    this.opponentName = data.playerName;
                    this.updatePlayerInfoDisplay();
                    this.showToast(`${data.playerName} đã tham gia!`, 'success');
                    this.messageElement.textContent = `Người chơi ${data.playerName} đã tham gia. Bắt đầu trò chơi!`;
                    // Bắt đầu game khi đủ người
                    this.startGame();
                    this.resetGameButton.style.display = 'none'; // Ẩn nút reset trong online mode
                });

                this.socket.on('playerLeft', (data) => {
                    this.showToast(`${data.playerName} đã rời phòng. Trò chơi kết thúc!`, 'info');
                    this.messageElement.textContent = `Đối thủ đã rời đi. Bạn thắng!`;
                    if (this.gameActive) { // Nếu game đang diễn ra
                        this.updateLocalStats('win'); // Tính thắng cho người ở lại
                    }
                    this.gameActive = false;
                    this.resetGameState(); // Reset lại trạng thái game và hiển thị nút tạo/tham gia phòng
                    this.showMainMenu();
                });

                this.socket.on('gameUpdate', (data) => {
                    this.board = data.board;
                    this.currentPlayer = data.currentPlayer;
                    this.gameActive = data.gameActive;
                    this.updateBoard();
                    const scores = this.updateScores();
                    this.updateTurnIndicator();
                    this.calculateValidMoves();
                    this.renderValidMoves();

                    if (!this.gameActive) {
                        this.endGame(scores);
                    } else if (this.playerColor === this.currentPlayer) {
                        this.showToast('Đến lượt bạn!', 'info');
                    } else {
                        this.showToast(`Lượt của ${this.opponentName}!`, 'info');
                    }
                });

                this.socket.on('gameEndedOnline', (data) => {
                    this.gameActive = false;
                    this.clearValidMovesHighlight();
                    let winnerMessage = '';
                    let outcome = '';

                    if (data.winnerColor === this.playerColor) {
                        winnerMessage = 'Bạn thắng!';
                        outcome = 'win';
                    } else if (data.winnerColor === 0) {
                        winnerMessage = 'Hòa!';
                        outcome = 'draw';
                    } else {
                        winnerMessage = 'Bạn thua!';
                        outcome = 'loss';
                    }
                    this.messageElement.textContent = `Trò chơi kết thúc! ${winnerMessage}`;
                    this.showToast(`Trò chơi kết thúc! ${winnerMessage}`, 'success');
                    this.updateLocalStats(outcome); // Cập nhật thống kê cục bộ cho game online
                    this.resetGameButton.style.display = 'none'; // Trong online, nút reset không phù hợp
                });

                this.socket.on('roomList', (rooms) => {
                    this.roomListElement.innerHTML = '';
                    if (rooms.length === 0) {
                        this.roomListElement.innerHTML = '<p>Chưa có phòng nào đang chờ.</p>';
                        return;
                    }
                    rooms.forEach(room => {
                        const roomItem = document.createElement('div');
                        roomItem.classList.add('room-item');
                        roomItem.innerHTML = `
                            <span>ID: ${room.id} (${room.playersCount}/2)</span>
                            <span>Host: ${room.hostName}</span>
                            <button onclick="game.joinRoomById('${room.id}')">Tham gia</button>
                        `;
                        this.roomListElement.appendChild(roomItem);
                    });
                });

                this.socket.on('chatMessage', (data) => {
                    const chatBox = document.getElementById('chat-messages');
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message');
                    messageElement.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;
                    chatBox.appendChild(messageElement);
                    chatBox.scrollTop = chatBox.scrollHeight; // Cuộn xuống cuối
                });

                this.socket.on('leaderboardUpdate', (data) => {
                    this.updateLeaderboardDisplay(data);
                });

                this.socket.on('gameStatsUpdate', (data) => {
                    this.updateStatsDisplay(data);
                });
            }

            joinRoomById(roomId) {
                document.getElementById('room-id-input').value = roomId;
                this.joinRoom();
            }

            sendChatMessage() {
                const chatInput = document.getElementById('chat-input');
                const message = chatInput.value.trim();
                if (message && this.isOnlineMode && this.roomId) {
                    this.socket.emit('chatMessage', { roomId: this.roomId, message: message });
                    chatInput.value = '';
                }
            }

            copyShareLink() {
                if (this.roomId) {
                    const shareLink = `${window.location.origin}?room=${this.roomId}`;
                    navigator.clipboard.writeText(shareLink).then(() => {
                        this.showToast('Liên kết phòng đã được sao chép!', 'success');
                    }).catch(err => {
                        console.error('Không thể sao chép liên kết: ', err);
                        this.showToast('Không thể sao chép liên kết.', 'error');
                    });
                } else {
                    this.showToast('Bạn chưa ở trong phòng nào để chia sẻ.', 'info');
                }
            }

            // =====================================
            // CÁC PHƯƠNG THỨC AI
            // =====================================
            makeAIMove() {
                if (!this.gameActive || this.currentPlayer !== 1) return; // AI là quân Trắng (1)
                
                let bestMove = null;
                let bestScore = -Infinity; // Đối với AI (quân Trắng), cố gắng tối đa hóa điểm của mình

                // Chuyển validMoves từ Map sang Array để dễ xử lý
                const movesArray = Array.from(this.validMoves.keys()).map(key => {
                    const [r, c] = key.split(',').map(Number);
                    return { r, c };
                });

                if (movesArray.length === 0) {
                    // Không có nước đi hợp lệ cho AI, bỏ qua lượt
                    this.nextTurn(this.updateScores());
                    return;
                }

                if (this.aiDifficulty === 'easy') {
                    // Chế độ dễ: Chọn một nước đi ngẫu nhiên
                    bestMove = movesArray[Math.floor(Math.random() * movesArray.length)];
                } else if (this.aiDifficulty === 'medium') {
                    // Chế độ trung bình: Chọn nước đi lật được nhiều quân nhất
                    let maxFlipped = -1;
                    for (const move of movesArray) {
                        // Tạo một bản sao bảng để thử nước đi mà không ảnh hưởng đến bảng gốc
                        const tempBoard = JSON.parse(JSON.stringify(this.board));
                        // Giả lập nước đi
                        tempBoard[move.r][move.c] = this.currentPlayer;
                        const tempFlipped = this.simulateFlipDiscs(tempBoard, move.r, move.c, this.currentPlayer);

                        if (tempFlipped > maxFlipped) {
                            maxFlipped = tempFlipped;
                            bestMove = move;
                        }
                    }
                } else if (this.aiDifficulty === 'hard') {
                    // Chế độ khó: Sử dụng Minimax (có thể đơn giản hóa hoặc dùng độ sâu nhỏ)
                    // Đây là một phiên bản Minimax rất đơn giản cho ví dụ
                    // Trong thực tế, cần cài đặt Minimax/Negamax với độ sâu và hàm đánh giá tốt hơn
                    bestMove = this.findBestMoveMinimax(this.board, this.currentPlayer, 2); // Độ sâu 2
                }

                if (bestMove) {
                    this.makeMove(bestMove.r, bestMove.c);
                } else {
                    // Fallback nếu không tìm thấy nước đi (chỉ xảy ra khi có lỗi logic)
                    console.warn("AI không tìm được nước đi hợp lệ dù có nước đi.");
                    this.nextTurn(this.updateScores());
                }
            }

            simulateFlipDiscs(boardCopy, r, c, player) {
                const opponent = this.getOpponentColor(player);
                let discsFlippedCount = 0;

                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;

                        let currentR = r + dr;
                        let currentC = c + dc;
                        let discsToFlip = [];

                        while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                            if (boardCopy[currentR][currentC] === opponent) {
                                discsToFlip.push({ r: currentR, c: currentC });
                            } else if (boardCopy[currentR][currentC] === player) {
                                discsFlippedCount += discsToFlip.length;
                                break;
                            } else {
                                break;
                            }
                            currentR += dr;
                            currentC += dc;
                        }
                    }
                }
                return discsFlippedCount;
            }

            findBestMoveMinimax(board, player, depth) {
                const validMoves = this.getValidMovesForPlayer(board, player);
                if (depth === 0 || validMoves.length === 0) {
                    return this.evaluateBoard(board, player);
                }

                let bestScore = -Infinity;
                let bestMove = null;

                for (const move of validMoves) {
                    const newBoard = JSON.parse(JSON.stringify(board));
                    newBoard[move.r][move.c] = player;
                    this.simulateFlipDiscsOnBoard(newBoard, move.r, move.c, player);

                    const score = -this.findBestMoveMinimax(newBoard, this.getOpponentColor(player), depth - 1);

                    if (score > bestScore) {
                        bestScore = score;
                        bestMove = move;
                    }
                }
                // Trong hàm Minimax chính, chúng ta trả về move, không phải score
                return depth === 2 ? bestMove : bestScore;
            }

            getValidMovesForPlayer(board, player) {
                const moves = [];
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (this.isValidMoveForBoard(board, r, c, player)) {
                            moves.push({ r, c });
                        }
                    }
                }
                return moves;
            }

            isValidMoveForBoard(board, r, c, player) {
                if (board[r][c] !== 0) return false;

                const opponent = this.getOpponentColor(player);
                let isValid = false;

                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;

                        let currentR = r + dr;
                        let currentC = c + dc;
                        let foundOpponent = false;
                        let pathLength = 0;

                        while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                            if (board[currentR][currentC] === opponent) {
                                foundOpponent = true;
                                pathLength++;
                            } else if (board[currentR][currentC] === player) {
                                if (foundOpponent && pathLength > 0) {
                                    isValid = true;
                                }
                                break;
                            } else {
                                break;
                            }
                            currentR += dr;
                            currentC += dc;
                        }
                    }
                }
                return isValid;
            }

            simulateFlipDiscsOnBoard(boardCopy, r, c, player) {
                const opponent = this.getOpponentColor(player);

                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;

                        let currentR = r + dr;
                        let currentC = c + dc;
                        let discsToFlip = [];

                        while (currentR >= 0 && currentR < 8 && currentC >= 0 && currentC < 8) {
                            if (boardCopy[currentR][currentC] === opponent) {
                                discsToFlip.push({ r: currentR, c: currentC });
                            } else if (boardCopy[currentR][currentC] === player) {
                                for (const disc of discsToFlip) {
                                    boardCopy[disc.r][disc.c] = player;
                                }
                                break;
                            } else {
                                break;
                            }
                            currentR += dr;
                            currentC += dc;
                        }
                    }
                }
            }

            evaluateBoard(board, player) {
                let playerScore = 0;
                let opponentScore = 0;
                const opponent = this.getOpponentColor(player);

                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        if (board[r][c] === player) {
                            playerScore++;
                        } else if (board[r][c] === opponent) {
                            opponentScore++;
                        }
                    }
                }
                return playerScore - opponentScore; // Trả về điểm số tương đối
            }

            // =====================================
            // QUẢN LÝ UI VÀ TRẠNG THÁI KHÁC
            // =====================================
            setupTabs() {
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Ẩn tất cả nội dung tab và xóa lớp 'active' khỏi tất cả các tab
                        tabContents.forEach(content => content.classList.remove('active'));
                        tabs.forEach(t => t.classList.remove('active'));

                        // Hiển thị nội dung tab được nhấp và thêm lớp 'active'
                        const targetTab = document.getElementById(tab.dataset.tab);
                        if (targetTab) {
                            targetTab.classList.add('active');
                        }
                        tab.classList.add('active');

                        // Nếu là tab Leaderboard hoặc Stats, yêu cầu dữ liệu mới nhất
                        if (tab.dataset.tab === 'leaderboard-tab') {
                            this.socket.emit('requestLeaderboard');
                        } else if (tab.dataset.tab === 'stats-tab') {
                            this.socket.emit('requestGameStats');
                            this.updateStatsDisplay(this.loadLocalStats()); // Hiển thị local stats trước
                        }
                    });
                });

                // Kích hoạt tab đầu tiên hoặc tab mặc định khi tải trang
                if (tabs.length > 0) {
                    tabs[0].click();
                }
            }

            updateLeaderboardDisplay(leaderboardData) {
                this.leaderboardTableBody.innerHTML = '';
                if (!leaderboardData || leaderboardData.length === 0) {
                    this.leaderboardTableBody.innerHTML = '<tr><td colspan="4">Chưa có dữ liệu bảng xếp hạng.</td></tr>';
                    return;
                }

                leaderboardData.forEach((entry, index) => {
                    const row = this.leaderboardTableBody.insertRow();
                    row.insertCell(0).textContent = index + 1;
                    row.insertCell(1).textContent = entry.playerName;
                    row.insertCell(2).textContent = entry.wins;
                    row.insertCell(3).textContent = entry.losses;
                    // row.insertCell(4).textContent = entry.draws;
                });
            }

            loadLocalStats() {
                try {
                    const statsString = localStorage.getItem('gameStats');
                    if (statsString) {
                        return new Map(JSON.parse(statsString));
                    }
                } catch (e) {
                    console.error("Error loading local stats:", e);
                }
                return new Map();
            }

            saveLocalStats() {
                try {
                    localStorage.setItem('gameStats', JSON.stringify(Array.from(gameStats.entries())));
                } catch (e) {
                    console.error("Error saving local stats:", e);
                }
            }

            updateStatsDisplay(statsData) {
                this.statsWins.textContent = statsData.get('wins') || 0;
                this.statsLosses.textContent = statsData.get('losses') || 0;
                this.statsDraws.textContent = statsData.get('draws') || 0;
                this.statsOnlineGames.textContent = statsData.get('onlineGames') || 0;
                this.statsOfflineGames.textContent = (statsData.get('offlineGames') || 0) + (statsData.get('aiGames') || 0); // Cộng dồn offline và AI
                this.statsMovesPlayed.textContent = statsData.get('totalMovesPlayed') || 0;
                this.statsDiscsFlipped.textContent = statsData.get('totalDiscsFlipped') || 0;
            }

            // Theme Management
            setTheme(theme) {
                localStorage.setItem('theme', theme);
                document.body.setAttribute('data-theme', theme);
                this.updateThemeOptions();
            }

            updateThemeOptions() {
                const currentTheme = localStorage.getItem('theme') || 'default';
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.theme === currentTheme) {
                        opt.classList.add('selected');
                    }
                });
            }

            // Prompt for player name if not set
            promptForPlayerName() {
                const playerNameModal = document.getElementById('player-name-modal');
                const submitNameBtn = document.getElementById('submit-name-btn');
                const nameInput = document.getElementById('player-name-input-modal');

                playerNameModal.style.display = 'flex'; // Hiển thị modal

                submitNameBtn.onclick = () => {
                    const name = nameInput.value.trim();
                    if (name) {
                        this.playerName = name;
                        localStorage.setItem('playerName', name);
                        document.getElementById('player-name').value = name; // Cập nhật input ở menu chính
                        playerNameModal.style.display = 'none'; // Ẩn modal
                    } else {
                        alert('Vui lòng nhập tên của bạn!');
                    }
                };

                // Đóng modal nếu người dùng click bên ngoài (tùy chọn)
                window.onclick = (event) => {
                    if (event.target == playerNameModal) {
                        // Không đóng nếu tên trống để đảm bảo người dùng nhập tên
                        if (nameInput.value.trim() === '') {
                            alert('Vui lòng nhập tên của bạn để tiếp tục!');
                        } else {
                            playerNameModal.style.display = 'none';
                        }
                    }
                };
            }

            showRules() {
                const rulesModal = document.getElementById('rules-modal');
                rulesModal.style.display = 'flex';
            }

            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
        }
    </script>
    <script>
        // Global game instance (khai báo ở đây để các hàm onclick có thể truy cập)
        let game;

        // Các hàm được gọi từ HTML (không thay đổi, chúng sẽ gọi các phương thức của game instance)
        // Các hàm này cần được định nghĩa ở đây để HTML có thể gọi chúng
        function createRoom(mode) { game.createRoom(mode); }
        function showJoinRoom() { game.showJoinRoom(); }
        function showAIMenu() { game.showAIMenu(); }
        function playOffline() { game.playOffline(); }
        function showLeaderboard() {
            game.showGameScreen(); // Đảm bảo chuyển đến màn hình game trước
            document.querySelector('.tab[data-tab="leaderboard-tab"]').click();
        }
        function showStats() {
            game.showGameScreen(); // Đảm bảo chuyển đến màn hình game trước
            document.querySelector('.tab[data-tab="stats-tab"]').click();
        }
        function joinRoom() { game.joinRoom(); }
        function backToMenu() { game.backToMenu(); }
        function createAIRoom() { game.createAIRoom(); }
        function startGame() { game.startGame(); } // Chức năng này có thể cần điều chỉnh nếu bạn muốn start game tự động sau join
        function leaveRoom() { game.leaveRoom(); }
        function resetGame() { game.resetGame(); }
        function showRules() { game.showRules(); }
        function leaveGame() { game.leaveGame(); } // Nếu có nút leave game riêng
        function sendChatMessage() { game.sendChatMessage(); }
        function copyShareLink() { game.copyShareLink(); }
        // Các hàm đóng modal
        function closeRulesModal() { game.closeModal('rules-modal'); }
        function closePlayerNameModal() { game.closeModal('player-name-modal'); }

        // Logic chuyển đổi Theme
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.dataset.theme;
                    if (game && typeof game.setTheme === 'function') {
                        game.setTheme(theme);
                    } else {
                        // Fallback nếu game chưa được khởi tạo (không nên xảy ra)
                        localStorage.setItem('theme', theme);
                        document.body.setAttribute('data-theme', theme);
                        document.querySelectorAll('.theme-option').forEach(opt => {
                            opt.classList.remove('selected');
                            if (opt.dataset.theme === theme) {
                                opt.classList.add('selected');
                            }
                        });
                    }
                });
            });
        });

        // Khởi tạo game khi trang tải xong
        window.addEventListener('DOMContentLoaded', () => {
            // Tại điểm này, lớp EnhancedOthelloGame đã được định nghĩa và có thể sử dụng
            game = new EnhancedOthelloGame();
            
            // Xử lý URL parameters (giữ nguyên logic của bạn)
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId && game) {
                document.getElementById('room-id-input').value = roomId;
                const savedPlayerName = localStorage.getItem('playerName');
                if (savedPlayerName) {
                    document.getElementById('player-name').value = savedPlayerName;
                    game.playerName = savedPlayerName; // Đảm bảo game instance cũng có playerName
                }
                game.showJoinRoom();
                game.showToast(`Sẵn sàng tham gia phòng ${roomId}. Nhập tên và nhấn \"Tham Gia\"!`, 'info');
            }
        });

        // Xử lý thay đổi khả năng hiển thị của trang (page visibility change)
        document.addEventListener('visibilitychange', () => {
            if (game && game.isOnlineMode && game.socket) {
                if (!document.hidden) {
                    // Trang hiển thị trở lại - kết nối lại nếu bị ngắt
                    if (game.socket.disconnected) {
                        game.socket.connect();
                    }
                }
            }
        });
    </script>
</body>
</html>
